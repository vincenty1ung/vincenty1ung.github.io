<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VINCENT CHYU - Music Stats</title>
    <!-- og -->
    <meta property="og:title" content="VINCENT CHYU éŸ³ä¹ç»Ÿè®¡" />
    <meta property="og:type" content="website" />
    <meta
      property="og:description"
      content="Vincent Chyu çš„éŸ³ä¹æ’­æ”¾ç»Ÿè®¡æ¿ï¼Œå±•ç¤ºå¬æ­Œä¹ æƒ¯å’Œåå¥½é¢‘é“ã€‚"
    />
    <meta
      property="og:url"
      content="https://blog-vincent.chyu.org/web/lastfm-scrobbler/"
    />
    <meta property="og:locale" content="zh_CN" />
    <meta property="og:site_name" content="VINCENT CHYU Portfolio" />
    <meta
      property="og:image"
      content="https://cdn-photography-img-vincent.chyu.org/info/favicon.png"
    />
    <meta
      property="og:image:secure_url"
      content="https://cdn-photography-img-vincent.chyu.org/info/favicon.png"
    />
    <meta property="og:image:type" content="image/png" />
    <meta property="og:image:alt" content="Vincent Chyu Icon" />

    <!-- twitteråˆ†äº«ä¼˜åŒ– -->
    <meta name="twitter:title" content="VINCENT CHYU éŸ³ä¹ç»Ÿè®¡" />
    <meta
      name="twitter:description"
      content="Vincent Chyu çš„éŸ³ä¹æ’­æ”¾ç»Ÿè®¡æ¿ï¼Œå±•ç¤ºå¬æ­Œä¹ æƒ¯å’Œåå¥½é¢‘é“ã€‚"
    />
    <meta
      name="twitter:image"
      content="https://cdn-photography-img-vincent.chyu.org/info/favicon.png"
    />
    <meta name="twitter:card" content="summary" />

    <!-- å¾®ä¿¡ä¸“ç”¨æ ‡ç­¾ -->
    <meta itemprop="name" content="VINCENT CHYU éŸ³ä¹ç»Ÿè®¡" />
    <meta
      itemprop="description"
      content="Vincent Chyu çš„éŸ³ä¹æ’­æ”¾ç»Ÿè®¡æ¿ï¼Œå±•ç¤ºå¬æ­Œä¹ æƒ¯å’Œåå¥½é¢‘é“ã€‚"
    />
    <meta
      itemprop="image"
      content="https://cdn-photography-img-vincent.chyu.org/info/favicon.png"
    />

    <!-- å¾®ä¿¡å°ç¨‹åº / å¾®ä¿¡æµè§ˆå™¨ -->
    <meta name="wechat:title" content="VINCENT CHYU éŸ³ä¹ç»Ÿè®¡" />
    <meta
      name="wechat:description"
      content="Vincent Chyu çš„éŸ³ä¹æ’­æ”¾ç»Ÿè®¡æ¿ï¼Œå±•ç¤ºå¬æ­Œä¹ æƒ¯å’Œåå¥½é¢‘é“ã€‚"
    />
    <meta
      name="wechat:image"
      content="https://cdn-photography-img-vincent.chyu.org/info/favicon.png"
    />
    <!-- og -->
    <link rel="icon" href="https://cdn-photography-img-vincent.chyu.org/info/favicon.png" />
    <link rel="apple-touch-icon" href="https://cdn-photography-img-vincent.chyu.org/info/favicon.png">
    <link rel="apple-touch-icon-precomposed" href="https://cdn-photography-img-vincent.chyu.org/info/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
      :root {
        --primary-color: #3498db;
        --secondary-color: #2ecc71;
        --background-color: #f8f9fa;
        --accent-color: #e74c3c;
        --text-primary: #2c3e50;
        --text-secondary: #7f8c8d;
        --card-bg: #ffffff;
        --border-color: #e9ecef;
        /* æ’­æ”¾æ¸ é“é¢œè‰² */
        --source-applemusic: #e74c3c; /* çº¢è‰² */
        --source-audirvana: #9b59b6; /* ç´«è‰² */
        --source-roon: #7f8c8d; /* ç°è‰² */
      }

      /* å¤œé—´æ¨¡å¼ */
      .dark-mode {
        --primary-color: #5dade2;
        --secondary-color: #58d68d;
        --background-color: #1a1a1a;
        --accent-color: #ec7063;
        --text-primary: #f0f0f0;
        --text-secondary: #bdc3c7;
        --card-bg: #2c2c2c;
        --border-color: #444444;
        /* æ’­æ”¾æ¸ é“é¢œè‰² */
        --source-applemusic: #ec7063; /* çº¢è‰² */
        --source-audirvana: #bb8fce; /* ç´«è‰² */
        --source-roon: #bdc3c7; /* ç°è‰² */
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--background-color);
        color: var(--text-primary);
        line-height: 1.6;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      /* é¡¶éƒ¨å¯¼èˆªæ  */
      .navbar {
        background-color: var(--card-bg);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 15px 0;
        margin-bottom: 30px;
        border-radius: 10px;
      }

      .navbar-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 20px;
      }

      .logo {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--primary-color);
        text-decoration: none;
      }

      .nav-links {
        display: flex;
        list-style: none;
      }

      .nav-links li {
        margin-left: 25px;
      }

      .nav-links a {
        text-decoration: none;
        color: var(--text-primary);
        font-weight: 500;
        padding: 8px 15px;
        border-radius: 5px;
        transition: all 0.3s ease;
      }

      .nav-links a:hover,
      .nav-links a.active {
        background-color: var(--primary-color);
        color: white;
      }

      /* ç»Ÿè®¡å¡ç‰‡ */
      .stats-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-card {
        background-color: var(--card-bg);
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        padding: 15px;
        display: flex;
        flex-direction: column;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        min-width: 150px;
        flex: 1;
      }

      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .stat-title {
        font-size: 0.9rem;
        color: var(--text-secondary);
        font-weight: 500;
      }

      .stat-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
      }

      .icon-1 {
        background-color: rgba(52, 152, 219, 0.1);
        color: var(--primary-color);
      }
      .icon-2 {
        background-color: rgba(46, 204, 113, 0.1);
        color: var(--secondary-color);
      }
      .icon-3 {
        background-color: rgba(231, 76, 60, 0.1);
        color: var(--accent-color);
      }
      .icon-4 {
        background-color: rgba(155, 89, 182, 0.1);
        color: #9b59b6;
      }

      .stat-value {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 3px;
      }

      .stat-change {
        font-size: 0.8rem;
        font-weight: 500;
      }

      .positive {
        color: var(--secondary-color);
      }
      .negative {
        color: var(--accent-color);
      }

      /* åŠ è½½å’Œé”™è¯¯çŠ¶æ€ */
      .loading,
      .error {
        text-align: center;
        padding: 20px;
      }

      .loading {
        color: var(--text-secondary);
      }

      .error {
        color: var(--accent-color);
        background-color: rgba(231, 76, 60, 0.1);
        border-radius: 8px;
      }

      /* å›¾è¡¨åŒºåŸŸ */
      .charts-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .chart-card {
        background-color: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        padding: 25px;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .card-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      .time-filters {
        display: flex;
        background-color: #f1f3f9;
        border-radius: 8px;
        padding: 4px;
      }

      .dark-mode .time-filters {
        background-color: #3a3a3a; /* å¤œé—´æ¨¡å¼ä¸‹çš„èƒŒæ™¯è‰² */
      }

      .time-filter {
        padding: 6px 12px;
        font-size: 0.9rem;
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.2s ease;
        background-color: #f1f3f9;
        color: #2c3e50;
        border: 1px solid #e9ecef;
      }

      .dark-mode .time-filter {
        background-color: #3a3a3a;
        color: var(--text-secondary);
        border: 1px solid #444444;
      }

      .time-filter.active {
        background-color: var(--primary-color);
        color: white;
        border: 1px solid var(--primary-color);
      }

      .dark-mode .time-filter.active {
        background-color: var(--primary-color);
        color: white;
        border: 1px solid var(--primary-color);
      }

      .time-filter:disabled {
        background-color: #e9ecef;
        color: #7f8c8d;
        cursor: not-allowed;
      }

      .dark-mode .time-filter:disabled {
        background-color: #444444;
        color: #7f8c8d;
        border: 1px solid #555555;
      }

      .chart-container {
        height: 300px;
        position: relative;
      }

      /* æ’è¡Œæ¦œå®¹å™¨ */
      .rankings-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      /* æ’è¡Œæ¦œ */
      .ranking-card {
        background-color: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        padding: 25px;
        margin-bottom: 0;
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .ranking-list {
        list-style: none;
        flex-grow: 1;
      }

      .ranking-item {
        display: flex;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid var(--border-color);
      }

      .ranking-item:last-child {
        border-bottom: none;
      }

      .rank-number {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-right: 15px;
      }

      .rank-1 {
        background-color: #ffd700;
        color: #333;
      }
      .rank-2 {
        background-color: #c0c0c0;
        color: #333;
      }
      .rank-3 {
        background-color: #cd7f32;
        color: #fff;
      }
      .rank-other {
        background-color: var(--primary-color);
        color: white;
      }

      .track-info {
        flex: 1;
      }

      .track-title {
        font-weight: 500;
        /* margin-bottom: 3px; */
      }

      .track-artist {
        font-size: 0.8rem;
        color: var(--text-secondary);
      }
      .track-album {
        font-size: 0.8rem;
        color: var(--text-secondary);
      }

      .play-count {
        font-weight: 700;
        color: var(--primary-color);
        font-size: 1.1rem;
      }

      /* æ’­æ”¾æ¸ é“æ ·å¼ */
      .play-source {
        font-size: 0.8rem;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 4px;
        margin-bottom: 4px;
        align-self: flex-end;
        display: inline-block;
        width: auto;
      }

      .source-applemusic {
        color: var(--source-applemusic);
        background-color: rgba(231, 76, 60, 0.1);
      }

      .source-audirvana {
        color: var(--source-audirvana);
        background-color: rgba(155, 89, 182, 0.1);
      }

      .source-roon {
        color: var(--source-roon);
        background-color: rgba(127, 140, 141, 0.1);
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 1200px) {
        .charts-container {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        .navbar-content {
          flex-direction: column;
          padding: 10px;
        }

        .nav-links {
          margin-top: 15px;
          flex-wrap: wrap;
          justify-content: center;
        }

        .nav-links li {
          margin: 5px;
        }

        .stats-container {
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        .ranking-item {
          flex-direction: column;
          align-items: flex-start;
        }

        .track-info {
          margin: 10px 0;
        }
      }

      @media (max-width: 480px) {
        .container {
          padding: 10px;
        }

        .stat-card {
          padding: 15px;
        }

        .stat-value {
          font-size: 1.8rem;
        }

        .charts-container {
          gap: 15px;
        }

        .chart-card {
          padding: 15px;
        }

        .card-header {
          flex-direction: column;
          align-items: flex-start;
        }

        .time-filters {
          margin-top: 10px;
          align-self: flex-start;
        }

        .ranking-item {
          padding: 10px 0;
        }

        .track-title {
          font-size: 1rem;
        }

        .track-artist {
          font-size: 0.9rem;
        }
      }

      /* è¶…å°å±å¹•ä¼˜åŒ– */
      @media (max-width: 320px) {
        .stat-card {
          padding: 10px;
        }

        .stat-title {
          font-size: 0.9rem;
        }

        .stat-value {
          font-size: 1.5rem;
        }

        .chart-card {
          padding: 10px;
        }
      }

      /* å…¨å±æŒ‰é’®ç®€çº¦æ ·å¼ */
      .fullscreen-btn {
        background-color: transparent;
        border: 1px solid #d1d1d1;
        border-radius: 4px;
        color: #666;
        padding: 4px 8px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .dark-mode .fullscreen-btn {
        border: 1px solid #555; /* å¤œé—´æ¨¡å¼ä¸‹çš„è¾¹æ¡†é¢œè‰² */
        color: var(--text-secondary);
      }

      .fullscreen-btn:hover {
        background-color: #f0f0f0;
        border-color: #a0a0a0;
        color: #333;
      }

      .dark-mode .fullscreen-btn:hover {
        background-color: #444; /* å¤œé—´æ¨¡å¼ä¸‹çš„æ‚¬åœèƒŒæ™¯è‰² */
        border-color: #777; /* å¤œé—´æ¨¡å¼ä¸‹çš„æ‚¬åœè¾¹æ¡†é¢œè‰² */
        color: var(--text-primary);
      }

      /* å®æ—¶æ’­æ”¾ä¿¡æ¯æ‚¬æµ®çª— */
      #nowPlaying {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 240px;
        background-color: rgba(255, 255, 255, 0.95); /* 90% ä¸é€æ˜åº¦ */
        border: 1px solid var(--border-color);
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        padding: 20px;
        z-index: 1000;
        display: none;
        animation: fadeIn 0.3s ease;
        cursor: move;
        user-select: none;
      }

      /* å¤œé—´æ¨¡å¼ä¸‹çš„æ­£åœ¨æ’­æ”¾æ‚¬æµ®çª— */
      .dark-mode #nowPlaying {
        background-color: rgba(44, 44, 44, 0.95); /* æš—è‰²èƒŒæ™¯ */
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      #nowPlaying h3 {
        margin-top: 0;
        color: var(--text-primary);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
        font-size: 1.2rem;
      }

      .dark-mode #nowPlaying h3 {
        color: var(--text-primary);
        border-bottom: 1px solid var(--border-color);
      }

      /* è°ƒæ•´æ‚¬æµ®çª—å†…å®¹åŒºåŸŸçš„æœ€å°é«˜åº¦ */
      #nowPlayingInfo {
        min-height: 100px;
      }

      .dark-mode #nowPlayingInfo {
        min-height: 100px;
      }

      /* å–œæ¬¢çŠ¶æ€æŒ‡ç¤ºå™¨å®¹å™¨ */
      .favorite-indicators-container {
        font-size: 0.5em;
        margin-top: 10px;
        text-align: right; /* å³å¯¹é½ */
      }

      .dark-mode .favorite-indicators-container {
        font-size: 0.5em;
        margin-top: 10px;
      }

      /* å–œæ¬¢çŠ¶æ€æŒ‡ç¤ºå™¨ */
      .favorite-indicator {
        display: inline-block;
        margin-left: 0;
        vertical-align: middle;
        font-size: 0.8em;
        color: var(--text-secondary);
      }

      .dark-mode .favorite-indicator {
        color: var(--text-secondary);
      }

      /* æ”¶è—æŒ‰é’®æ ·å¼è°ƒæ•´ */
      .favorite-button {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        transition: transform 0.2s ease, color 0.2s ease;
        margin-top: 10px;
        padding: 0;
        width: auto;
        height: auto;
      }

      .dark-mode .favorite-button {
        background: none;
        border: none;
      }

      .favorite-button:hover {
        transform: scale(1.1);
      }

      .dark-mode .favorite-button:hover {
        transform: scale(1.1);
      }

      .favorite-button.liked {
        color: var(--source-applemusic);
        cursor: not-allowed; /* å·²æ”¶è—æ—¶ç¦ç”¨ç‚¹å‡» */
      }

      .dark-mode .favorite-button.liked {
        color: var(--source-applemusic);
        cursor: not-allowed; /* å·²æ”¶è—æ—¶ç¦ç”¨ç‚¹å‡» */
      }

      .favorite-button.unliked {
        color: #ccc;
      }

      .dark-mode .favorite-button.unliked {
        color: #888; /* å¤œé—´æ¨¡å¼ä¸‹ä½¿ç”¨è¾ƒæš—çš„ç°è‰² */
      }

      /* æ­Œæ›²æ ‡é¢˜å’Œæ”¶è—æŒ‰é’®å®¹å™¨ */
      .track-title-favorite-container {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 5px;
      }

      .dark-mode .track-title-favorite-container {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 5px;
      }

      /* ç¡®ä¿æ­Œæ›²æ ‡é¢˜åœ¨å®¹å™¨ä¸­æ­£ç¡®æ˜¾ç¤º */
      .track-title {
        flex-grow: 1; /* å…è®¸æ ‡é¢˜å æ®å¯ç”¨ç©ºé—´ */
        white-space: nowrap; /* é˜²æ­¢æ ‡é¢˜æ¢è¡Œ */
        overflow: hidden; /* éšè—è¶…å‡ºéƒ¨åˆ† */
        text-overflow: ellipsis; /* è¶…å‡ºéƒ¨åˆ†æ˜¾ç¤ºçœç•¥å· */
      }

      .dark-mode .track-title {
        color: var(--text-primary); /* å¤œé—´æ¨¡å¼ä¸‹ä½¿ç”¨ä¸»æ–‡æœ¬é¢œè‰² */
      }

      /* æ­£åœ¨æ’­æ”¾æ‚¬æµ®çª—å¤´éƒ¨ */
      .now-playing-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: -20px -20px 15px -20px;
        padding: 8px 15px;
        border-bottom: 1px solid var(--border-color);
        cursor: move;
      }

      .dark-mode .now-playing-header {
        border-bottom: 1px solid var(--border-color);
      }

      /* æ­£åœ¨æ’­æ”¾æ§åˆ¶æŒ‰é’® */
      .now-playing-controls {
        display: flex;
        gap: 5px;
      }

      .dark-mode .now-playing-controls {
        display: flex;
        gap: 5px;
      }

      /* æ‹–åŠ¨æŠŠæ‰‹ */
      .drag-handle {
        cursor: move;
        font-size: 1.2rem;
        color: #95a5a6;
        padding: 0 3px;
      }

      .dark-mode .drag-handle {
        color: #bdc3c7; /* å¤œé—´æ¨¡å¼ä¸‹ä½¿ç”¨è¾ƒäº®çš„é¢œè‰² */
      }

      /* ç¼©å°æŠŠæ‰‹ */
      .minimize-handle {
        cursor: pointer;
        font-size: 1.2rem;
        color: #95a5a6;
        padding: 0 3px;
        font-weight: bold;
      }

      .dark-mode .minimize-handle {
        color: #bdc3c7; /* å¤œé—´æ¨¡å¼ä¸‹ä½¿ç”¨è¾ƒäº®çš„é¢œè‰² */
      }

      /* æ‹–åŠ¨æ—¶çš„æ ·å¼ */
      #nowPlaying.dragging {
        opacity: 0.8;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
      }

      .dark-mode #nowPlaying.dragging {
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
      }

      /* ç¼©å°çŠ¶æ€çš„æ ·å¼ */
      #nowPlaying.minimized {
        width: 150px;
        height: 60px;
        padding: 10px;
      }

      .dark-mode #nowPlaying.minimized {
        width: 150px;
        height: 60px;
        padding: 10px;
      }

      #nowPlaying.minimized .now-playing-header {
        margin: -10px -10px 10px -10px;
        padding: 5px 10px;
      }

      .dark-mode #nowPlaying.minimized .now-playing-header {
        margin: -10px -10px 10px -10px;
        padding: 5px 10px;
      }

      #nowPlaying.minimized #nowPlayingInfo {
        display: none;
      }

      .dark-mode #nowPlaying.minimized #nowPlayingInfo {
        display: none;
      }

      #nowPlaying.minimized h3 {
        font-size: 1rem;
        padding-bottom: 0;
        border-bottom: none;
        margin-bottom: 0;
      }

      .dark-mode #nowPlaying.minimized h3 {
        font-size: 1rem;
        padding-bottom: 0;
        border-bottom: none;
        margin-bottom: 0;
      }

      /* æœªä¸ŠæŠ¥è®°å½•å®¹å™¨ */
      .dark-mode #unscrobbledContainer .chart-card {
        background-color: var(--card-bg);
        color: var(--text-primary);
      }

      .dark-mode #unscrobbledContainer .card-title {
        color: var(--text-primary);
      }

      .dark-mode #unscrobbledContainer .loading {
        color: var(--text-secondary);
      }

      /* æœªä¸ŠæŠ¥è®°å½•è¡¨æ ¼ */
      .dark-mode #unscrobbledContainer table {
        color: var(--text-primary);
      }

      .dark-mode #unscrobbledContainer table thead tr {
        background-color: #3a3a3a;
      }

      .dark-mode #unscrobbledContainer table thead th {
        border-bottom: 2px solid #444444;
      }

      .dark-mode #unscrobbledContainer table tbody tr {
        border-bottom: 1px solid #444444;
      }

      /* æœªä¸ŠæŠ¥è®°å½•åˆ†é¡µ */
      .dark-mode #unscrobbledContainer #pagination {
        color: var(--text-primary);
      }

      /* å–œæ¬¢çŠ¶æ€æŒ‡ç¤ºå™¨ */
      .favorite-indicator {
        display: inline-block;
        margin-left: 10px;
        vertical-align: middle;
        font-size: 0.8em;
        color: var(--text-secondary);
      }

      /* ç‚¹èµæŒ‰é’® */
      .favorite-button {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        transition: transform 0.2s ease, color 0.2s ease;
        margin-top: 10px;
        padding: 0;
        width: auto;
        height: auto;
      }

      .dark-mode .favorite-button {
        background: none;
        border: none;
      }

      .favorite-button:hover {
        transform: scale(1.1);
      }

      .favorite-button.liked {
        color: var(--source-applemusic);
        cursor: not-allowed; /* å·²æ”¶è—æ—¶ç¦ç”¨ç‚¹å‡» */
      }

      .favorite-button.unliked {
        color: #ccc;
      }

      /* æ’­æ”¾è¿›åº¦æ¡å®¹å™¨ */
      .progress-container {
        width: 100%;
        margin: 15px 0 10px 0;
        position: relative;
      }

      .dark-mode .progress-container {
        width: 100%;
        margin: 15px 0 10px 0;
      }

      /* è¿›åº¦æ¡è½¨é“ */
      .progress-track {
        width: 100%;
        height: 6px;
        background-color: #e9ecef;
        border-radius: 3px;
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }

      .dark-mode .progress-track {
        background-color: #555; /* å¤œé—´æ¨¡å¼ä¸‹ä½¿ç”¨è¾ƒæš—çš„èƒŒæ™¯ */
      }

      /* è¿›åº¦æ¡å·²å®Œæˆéƒ¨åˆ† */
      .progress-fill {
        height: 100%;
        background-color: var(--primary-color);
        border-radius: 3px;
        width: 0%;
        transition: width 0.3s ease;
      }

      .dark-mode .progress-fill {
        background-color: var(--primary-color);
      }

      /* è¿›åº¦æ¡æ‹–æ‹½ç‚¹ */
      .progress-thumb {
        position: absolute;
        top: 50%;
        right: 0;
        transform: translate(50%, -50%);
        width: 12px;
        height: 12px;
        background-color: var(--primary-color);
        border-radius: 50%;
        opacity: 0;
        transition: opacity 0.2s ease;
        pointer-events: none;
      }

      .dark-mode .progress-thumb {
        background-color: var(--primary-color);
      }

      .progress-track:hover .progress-thumb {
        opacity: 1;
      }

      .dark-mode .progress-track:hover .progress-thumb {
        opacity: 1;
      }

      /* æ’­æ”¾è¿›åº¦æ—¶é—´æ˜¾ç¤º */
      .progress-time {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-top: 5px;
      }

      .dark-mode .progress-time {
        color: var(--text-secondary);
      }

      /* æ¨¡æ€æ¡†æ ·å¼ */
      .modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
      }

      .modal-content {
        background-color: var(--card-bg);
        margin: 5% auto;
        padding: 0;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        width: 80%;
        max-width: 600px;
        box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
        animation-name: animatetop;
        animation-duration: 0.3s;
      }

      @keyframes animatetop {
        from {top: -300px; opacity: 0}
        to {top: 0; opacity: 1}
      }

      .modal-header {
        padding: 15px 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h2 {
        margin: 0;
        color: var(--text-primary);
      }

      .close {
        color: var(--text-secondary);
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close:hover,
      .close:focus {
        color: var(--text-primary);
      }

      .modal-body {
        padding: 20px;
        color: var(--text-primary);
      }

      .modal-body .track-info p {
        margin: 10px 0;
      }

      .modal-body .track-info strong {
        color: var(--primary-color);
      }
    </style>
  </head>
  <body>
    <!-- å®æ—¶æ’­æ”¾ä¿¡æ¯æ‚¬æµ®çª— -->
    <div id="nowPlaying">
      <div class="now-playing-header">
        <h4>æ­£åœ¨æ’­æ”¾</h4>
        <div class="now-playing-controls">
          <div class="drag-handle">â‹®</div>
          <div class="minimize-handle">âˆ’</div>
        </div>
      </div>
      <div id="nowPlayingInfo">
        <div class="track-title-favorite-container">
          <div class="track-title" id="trackTitle"></div>
          <button
            class="favorite-button unliked"
            id="favoriteButton"
            title="æ·»åŠ åˆ°å–œæ¬¢"
          ></button>
        </div>

        <div class="track-artist" id="trackArtist"></div>
        <div class="track-album" id="trackAlbum">-</div>

        <!-- æ’­æ”¾è¿›åº¦æ˜¾ç¤º -->
        <div class="progress-container">
          <div class="progress-track" id="progressTrack">
            <div class="progress-fill" id="progressFill"></div>
            <div class="progress-thumb" id="progressThumb"></div>
          </div>
          <div class="progress-time">
            <span id="currentTime">00:00</span>
            <span id="totalTime">00:00</span>
          </div>
        </div>

        <div class="track-source" id="trackSource"></div>
        <div class="favorite-indicators-container">
          <div class="favorite-indicators" id="favoriteIndicators"></div>
        </div>
      </div>
    </div>

    <div class="container">
      <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
      <nav class="navbar">
        <div class="navbar-content">
          <a href="./" class="logo">éŸ³ä¹ç»Ÿè®¡ç³»ç»Ÿ</a>
          <ul class="nav-links">
            <li><a href="./" class="active">ä»ªè¡¨æ¿</a></li>
            <li><a href="#" id="unscrobbledTab">æœªä¸ŠæŠ¥</a></li>
            <li><a href="../../web/photography/">å…‰ç»˜é›†</a></li>
           <!-- <li><a href="/report">åˆ†ææŠ¥å‘Š</a></li>-->
            <!--<li><a href="/playCounts">æ’­æ”¾ç»Ÿè®¡</a></li>-->
          </ul>
        </div>
      </nav>

      <!-- ç»Ÿè®¡å¡ç‰‡ -->
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-title">æ€»æ’­æ”¾æ¬¡æ•°</div>
            <div class="stat-icon icon-1">â–¶ï¸</div>
          </div>
          <div class="stat-value" id="totalPlays">0</div>
          <div class="stat-change positive">â†‘ 12% æœ¬æœˆ</div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-title">æ›²ç›®æ€»æ•°</div>
            <div class="stat-icon icon-2">ğŸµ</div>
          </div>
          <div class="stat-value" id="totalTracks">0</div>
          <div class="stat-change positive">â†‘ 5% æœ¬æœˆ</div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-title">è‰ºæœ¯å®¶æ•°é‡</div>
            <div class="stat-icon icon-3">ğŸ¤</div>
          </div>
          <div class="stat-value" id="totalArtists">0</div>
          <div class="stat-change negative">â†“ 2% æœ¬æœˆ</div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-title">ä¸“è¾‘æ•°é‡</div>
            <div class="stat-icon icon-4">ğŸ’¿</div>
          </div>
          <div class="stat-value" id="totalAlbums">0</div>
          <div class="stat-change positive">â†‘ 8% æœ¬æœˆ</div>
        </div>

        <!-- æ’­æ”¾æ¥æºç»Ÿè®¡å¡ç‰‡ -->
        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-title">æ’­æ”¾æ¥æºåˆ†å¸ƒ</div>
            <div class="stat-icon icon-1">ğŸ“Š</div>
          </div>
          <div
            class="chart-container"
            style="height: 120px; position: relative"
          >
            <canvas id="sourceChart"></canvas>
          </div>
        </div>
      </div>

      <!-- å›¾è¡¨åŒºåŸŸ -->
      <div class="charts-container">
        <!-- çƒ­é—¨è‰ºæœ¯å®¶ -->
        <div class="chart-card">
          <div class="card-header">
            <div class="card-title">çƒ­é—¨è‰ºæœ¯å®¶</div>
            <div class="time-filters">
              <div class="time-filter active" data-type="plays">æ’­æ”¾æ¬¡æ•°</div>
              <div class="time-filter" data-type="tracks">æ›²ç›®æ•°</div>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="artistChart"></canvas>
          </div>
        </div>

        <!-- çƒ­é—¨ä¸“è¾‘ -->
        <div class="chart-card">
          <div class="card-header">
            <div class="card-title">çƒ­é—¨ä¸“è¾‘</div>
            <div class="time-filters">
              <div class="time-filter active" data-days="7">7å¤©</div>
              <div class="time-filter" data-days="30">30å¤©</div>
              <div class="time-filter" data-days="90">90å¤©</div>
              <div class="time-filter" data-days="365">365å¤©</div>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="albumChart"></canvas>
          </div>
        </div>
      </div>

      <!-- ç¬¬äºŒè¡Œå›¾è¡¨ï¼šå£å‘³æµæ´¾å’Œæ’­æ”¾è¶‹åŠ¿ -->
      <div class="charts-container">
        <!-- çƒ­é—¨æµæ´¾ -->
        <div class="chart-card">
          <div class="card-header">
            <div class="card-title">å£å‘³æµæ´¾</div>
            <button id="genreChartFullscreenBtn" class="fullscreen-btn">
              å…¨å±
            </button>
          </div>
          <div class="chart-container">
            <canvas id="genreChart"></canvas>
          </div>
        </div>

        <!-- æ’­æ”¾è¶‹åŠ¿å›¾ -->
        <div class="chart-card">
          <!-- <div class="chart-card" style="grid-column: span 2"> -->
          <div class="card-header">
            <div class="card-title">æ’­æ”¾è¶‹åŠ¿</div>
            <div style="display: flex; gap: 10px">
              <div class="time-filters">
                <div class="time-filter" data-range="7">7å¤©</div>
                <div class="time-filter active" data-range="30">30å¤©</div>
                <div class="time-filter" data-range="90">90å¤©</div>
              </div>
              <button id="trendChartFullscreenBtn" class="fullscreen-btn">
                å…¨å±
              </button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="trendChart"></canvas>
          </div>
        </div>
      </div>

      <!-- æœ€è¿‘æ’­æ”¾å’Œæ’­æ”¾æ’è¡Œå¹¶æ’æ˜¾ç¤º -->
      <div class="rankings-container">
        <!-- æœ€è¿‘æ’­æ”¾ -->
        <div class="ranking-card" id="recentPlaysCard">
          <div class="card-header">
            <div class="card-title">æœ€è¿‘æ’­æ”¾</div>
          </div>
          <ul class="ranking-list" id="recentPlaysList">
            <!-- æœ€è¿‘æ’­æ”¾é¡¹ç›®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            <div class="loading">åŠ è½½ä¸­...</div>
          </ul>
        </div>

        <!-- æ’­æ”¾æ’è¡Œæ¦œ -->
        <div class="ranking-card" id="rankingCard">
          <div class="card-header">
            <div class="card-title">æ’­æ”¾æ’è¡Œæ¦œ</div>
            <div class="time-filters">
              <div class="time-filter active" data-ranking="all">æ€»æ’è¡Œ</div>
              <div class="time-filter" data-ranking="month">æœ¬æœˆ</div>
              <div class="time-filter" data-ranking="week">æœ¬å‘¨</div>
            </div>
          </div>
          <ul class="ranking-list" id="rankingList">
            <!-- æ’è¡Œæ¦œé¡¹ç›®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            <div class="loading">åŠ è½½ä¸­...</div>
          </ul>
        </div>
      </div>

      <!-- æœªä¸ŠæŠ¥è®°å½•å®¹å™¨ -->
      <div id="unscrobbledContainer" style="display: none">
        <div class="chart-card">
          <div class="card-header">
            <div class="card-title">æœªä¸ŠæŠ¥è®°å½•</div>
            <div>
              <button
                id="syncSelectedBtn"
                class="time-filter"
                style="margin-right: 10px"
              >
                åŒæ­¥é€‰ä¸­
              </button>
              <button id="refreshUnscrobbledBtn" class="time-filter">
                åˆ·æ–°
              </button>
            </div>
          </div>
          <div id="unscrobbledContent">
            <div class="loading">åŠ è½½ä¸­...</div>
          </div>
          <div
            id="pagination"
            style="display: flex; justify-content: center; margin-top: 20px"
          >
            <button id="prevPage" class="time-filter" disabled>ä¸Šä¸€é¡µ</button>
            <span
              id="pageInfo"
              style="margin: 0 15px; line-height: 36px"
            ></span>
            <button id="nextPage" class="time-filter">ä¸‹ä¸€é¡µ</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // WebSocketè¿æ¥
      let ws = null;
      
      // API åŸºç¡€ URL é…ç½®
      // å¦‚æœæ˜¯ç‹¬ç«‹éƒ¨ç½² Workerï¼Œè¯·åœ¨æ­¤å¡«å…¥ Worker URLï¼Œä¾‹å¦‚ "https://lastfm-api.your-name.workers.dev"
      // å¦‚æœç•™ç©ºï¼Œåˆ™ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆé€‚ç”¨äº Pages Functionsï¼‰
      const API_BASE_URL = "https://lastfm-scrobbler-api-vincent.chyu.org";

      // è‡ªåŠ¨åˆ‡æ¢æ—¥å¤œæ¨¡å¼
      function toggleDarkModeBasedOnSystem() {
        const body = document.body;

        // æ£€æŸ¥ç³»ç»Ÿä¸»é¢˜åå¥½
        if (
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches
        ) {
          body.classList.add("dark-mode");
        } else {
          body.classList.remove("dark-mode");
        }

        // é‡æ–°åŠ è½½æ‰€æœ‰å›¾è¡¨ä»¥é€‚åº”ä¸»é¢˜æ¨¡å¼
        reloadAllCharts();
      }

      // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
      function watchSystemThemeChange() {
        if (window.matchMedia) {
          const mediaQuery = window.matchMedia("(prefers-color-scheme: dark)");
          mediaQuery.addEventListener("change", toggleDarkModeBasedOnSystem);
        }
      }

      // æ£€æŸ¥æ˜¯å¦å¤„äºæš—è‰²æ¨¡å¼
      function isDarkMode() {
        return document.body.classList.contains("dark-mode");
      }

      // è·å–å›¾è¡¨çš„æš—è‰²æ¨¡å¼é…ç½®
      function getChartDarkModeOptions() {
        if (isDarkMode()) {
          return {
            color: "#f0f0f0", // æ–‡æœ¬é¢œè‰²
            borderColor: "#444444", // è¾¹æ¡†é¢œè‰²
            backgroundColor: "#2c2c2c", // èƒŒæ™¯é¢œè‰²
            gridColor: "rgba(255, 255, 255, 0.1)", // ç½‘æ ¼çº¿é¢œè‰²
            ticksColor: "#bdc3c7", // åˆ»åº¦é¢œè‰²
          };
        } else {
          return {
            color: "#2c3e50", // æ–‡æœ¬é¢œè‰²
            borderColor: "#e9ecef", // è¾¹æ¡†é¢œè‰²
            backgroundColor: "#ffffff", // èƒŒæ™¯é¢œè‰²
            gridColor: "rgba(0, 0, 0, 0.05)", // ç½‘æ ¼çº¿é¢œè‰²
            ticksColor: "#7f8c8d", // åˆ»åº¦é¢œè‰²
          };
        }
      }

      // é‡æ–°åŠ è½½æ‰€æœ‰å›¾è¡¨ä»¥é€‚åº”ä¸»é¢˜å˜åŒ–
      function reloadAllCharts() {
        // é‡æ–°åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨
        initSourceChart();
        initGenreChart();

        // é‡æ–°åˆå§‹åŒ–å½“å‰æ¿€æ´»çš„å›¾è¡¨
        const trendRange =
          document
            .querySelector(".time-filter.active[data-range]")
            ?.getAttribute("data-range") || 30;
        initTrendChart(trendRange);

        const artistType =
          document
            .querySelector(".time-filter.active[data-type]")
            ?.getAttribute("data-type") || "plays";
        initArtistChart(artistType);

        const albumDays =
          document
            .querySelector(".time-filter.active[data-days]")
            ?.getAttribute("data-days") || 30;
        initAlbumChart(albumDays);

        // å¦‚æœæœªä¸ŠæŠ¥é¡µé¢å¯è§ï¼Œé‡æ–°åŠ è½½å…¶å†…å®¹ä»¥é€‚åº”ä¸»é¢˜å˜åŒ–
        const unscrobbledContainer = document.getElementById(
          "unscrobbledContainer"
        );
        if (
          unscrobbledContainer &&
          unscrobbledContainer.style.display !== "none"
        ) {
          loadUnscrobbledRecords();
        }

        // æ›´æ–°å…¨å±æ¨¡å¼ä¸‹çš„å›¾è¡¨èƒŒæ™¯è‰²
        updateFullscreenChartBackground();
      }

      // æ›´æ–°å…¨å±æ¨¡å¼ä¸‹çš„å›¾è¡¨èƒŒæ™¯è‰²
      function updateFullscreenChartBackground() {
        // æ›´æ–°è¶‹åŠ¿å›¾å…¨å±èƒŒæ™¯
        const trendFullscreenOverlay = document.getElementById(
          "trendChartFullscreenOverlay"
        );
        if (trendFullscreenOverlay) {
          const isDark = document.body.classList.contains("dark-mode");
          const backgroundColor = isDark ? "#2c2c2c" : "white";
          const textColor = isDark ? "#f0f0f0" : "#2c3e50";
          trendFullscreenOverlay.querySelector("div").style.backgroundColor =
            backgroundColor;
          trendFullscreenOverlay.querySelector("div").style.color = textColor;
        }

        // æ›´æ–°æµæ´¾å›¾å…¨å±èƒŒæ™¯
        const genreFullscreenOverlay = document.getElementById(
          "genreChartFullscreenOverlay"
        );
        if (genreFullscreenOverlay) {
          const isDark = document.body.classList.contains("dark-mode");
          const backgroundColor = isDark ? "#2c2c2c" : "white";
          const textColor = isDark ? "#f0f0f0" : "#2c3e50";
          genreFullscreenOverlay.querySelector("div").style.backgroundColor =
            backgroundColor;
          genreFullscreenOverlay.querySelector("div").style.color = textColor;
        }
      }

      // è¿æ¥åˆ°WebSocketæœåŠ¡å™¨
      function connectWebSocket() {
        // åˆ›å»ºWebSocketè¿æ¥
        ws = new WebSocket("ws://" + window.location.host + "/ws");

        // è¿æ¥æ‰“å¼€æ—¶çš„å¤„ç†
        ws.onopen = function (event) {
          console.log("WebSocketè¿æ¥å·²å»ºç«‹");
        };

        // æ”¶åˆ°æ¶ˆæ¯æ—¶çš„å¤„ç†
        ws.onmessage = function (event) {
          const data = JSON.parse(event.data);
          if (data.type === "now_playing") {
            // æ›´æ–°æ­£åœ¨æ’­æ”¾çš„ä¿¡æ¯
            updateNowPlaying(data.source, data.data);
          } else if (data.type === "stop") {
            // éšè—æ­£åœ¨æ’­æ”¾çš„æ‚¬æµ®çª—
            document.getElementById("nowPlaying").style.display = "none";
            // æ¸…é™¤è¿›åº¦æ›´æ–°å®šæ—¶å™¨
            if (progressInterval) {
              clearInterval(progressInterval);
              progressInterval = null;
            }
          }
        };

        // è¿æ¥å…³é—­æ—¶çš„å¤„ç†
        ws.onclose = function (event) {
          console.log("WebSocketè¿æ¥å·²å…³é—­");
          // æ¸…é™¤è¿›åº¦æ›´æ–°å®šæ—¶å™¨
          if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
          }
          // 5ç§’åå°è¯•é‡æ–°è¿æ¥
          setTimeout(connectWebSocket, 5000);
        };

        // è¿æ¥é”™è¯¯æ—¶çš„å¤„ç†
        ws.onerror = function (error) {
          console.log("WebSocketè¿æ¥å‡ºé”™:", error);
          // æ¸…é™¤è¿›åº¦æ›´æ–°å®šæ—¶å™¨
          if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
          }
        };
      }

      // å½“å‰æ’­æ”¾çš„æ›²ç›®ä¿¡æ¯
      let currentTrackInfo = null;
      let currentSource = null;
      let currentPosition = 0; // å½“å‰æ’­æ”¾ä½ç½®
      let trackDuration = 0; // æ­Œæ›²æ€»æ—¶é•¿
      let progressInterval = null; // è¿›åº¦æ›´æ–°å®šæ—¶å™¨

      // æ ¼å¼åŒ–æ—¶é—´ï¼ˆç§’è½¬ä¸ºmm:ssï¼‰
      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins.toString().padStart(2, "0")}:${secs
          .toString()
          .padStart(2, "0")}`;
      }

      // æ›´æ–°æ’­æ”¾è¿›åº¦æ˜¾ç¤º
      function updateProgressDisplay() {
        if (trackDuration <= 0) return;

        // æ›´æ–°è¿›åº¦æ¡
        const progressPercent = (currentPosition / trackDuration) * 100;
        document.getElementById("progressFill").style.width = `${Math.min(
          progressPercent,
          100
        )}%`;

        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        document.getElementById("currentTime").textContent =
          formatTime(currentPosition);
        document.getElementById("totalTime").textContent =
          formatTime(trackDuration);

        // æ›´æ–°å½“å‰ä½ç½®
        currentPosition += 1;

        // å¦‚æœæ’­æ”¾å®Œæˆï¼Œæ¸…é™¤å®šæ—¶å™¨
        if (currentPosition >= trackDuration) {
          clearInterval(progressInterval);
          progressInterval = null;
        }
      }

      // æ›´æ–°æ­£åœ¨æ’­æ”¾çš„ä¿¡æ¯
      function updateNowPlaying(source, data) {
        // ä¿å­˜å½“å‰æ’­æ”¾ä¿¡æ¯
        currentTrackInfo = data;
        currentSource = source;

        // é‡ç½®æ’­æ”¾è¿›åº¦
        currentPosition = data.position || 0;
        trackDuration = data.duration || 0;

        // æ¸…é™¤ä¹‹å‰çš„è¿›åº¦æ›´æ–°å®šæ—¶å™¨
        if (progressInterval) {
          clearInterval(progressInterval);
          progressInterval = null;
        }

        // å¯åŠ¨æ–°çš„è¿›åº¦æ›´æ–°å®šæ—¶å™¨ï¼ˆå¦‚æœæ­Œæ›²æœ‰æŒç»­æ—¶é—´ï¼‰
        if (trackDuration > 0) {
          // ç«‹å³æ›´æ–°ä¸€æ¬¡æ˜¾ç¤º
          updateProgressDisplay();
          // æ¯ç§’æ›´æ–°ä¸€æ¬¡è¿›åº¦
          progressInterval = setInterval(updateProgressDisplay, 1000);
        }

        // æ˜¾ç¤ºæ‚¬æµ®çª—
        document.getElementById("nowPlaying").style.display = "block";

        // æ ¹æ®æ¥æºæ›´æ–°ä¿¡æ¯
        let sourceClass = "";
        let sourceText = "";

        if (source === "Audirvana") {
          document.getElementById("trackTitle").textContent = " " + data.title;
          document.getElementById("trackAlbum").textContent =
            "ã€Š " + data.album + "ã€‹";
          document.getElementById("trackArtist").textContent =
            " - " + data.artist;
          sourceClass = "source-audirvana";
          sourceText = "Audirvana";
        } else if (source === "Roon") {
          document.getElementById("trackTitle").textContent = " " + data.title;
          document.getElementById("trackAlbum").textContent =
            "ã€Š " + data.album + " ã€‹";
          document.getElementById("trackArtist").textContent =
            " - " + data.artist;
          sourceClass = "source-roon";
          sourceText = "Roon";
        } else if (source === "Apple Music") {
          document.getElementById("trackTitle").textContent = " " + data.title;
          document.getElementById("trackAlbum").textContent =
            "ã€Š " + data.album + " ã€‹";
          document.getElementById("trackArtist").textContent =
            " - " + data.artist;
          sourceClass = "source-applemusic";
          sourceText = "AppleMusic";
        }

        // æ›´æ–°æ’­æ”¾æ¸ é“æ˜¾ç¤ºæ ·å¼
        const trackSourceElement = document.getElementById("trackSource");
        trackSourceElement.textContent = sourceText;
        trackSourceElement.className = "play-source " + sourceClass;

        // æ›´æ–°å–œæ¬¢çŠ¶æ€æŒ‡ç¤ºå™¨
        updateFavoriteIndicators(data.apple_music, data.lastfm);

        // æ›´æ–°ç‚¹èµæŒ‰é’®çŠ¶æ€
        updateFavoriteButtonState(data.apple_music);
      }

      // æ›´æ–°å–œæ¬¢çŠ¶æ€æŒ‡ç¤ºå™¨
      function updateFavoriteIndicators(appleMusicFav, lastFmFav) {
        const indicatorsContainer =
          document.getElementById("favoriteIndicators");
        indicatorsContainer.innerHTML = "";

        if (appleMusicFav && lastFmFav) {
          // ä¸¤ä¸ªéƒ½å–œæ¬¢ï¼Œæ˜¾ç¤ºæ–‡æœ¬æç¤º
          const indicator = document.createElement("span");
          indicator.className = "favorite-indicator";
          indicator.innerHTML = "Apple Music å’Œ Last.fm éƒ½å–œæ¬¢";
          indicator.title = "Apple Music å’Œ Last.fm éƒ½å–œæ¬¢";
          indicatorsContainer.appendChild(indicator);
        } else if (appleMusicFav) {
          // åªæœ‰Apple Musicå–œæ¬¢ï¼Œæ˜¾ç¤ºæ–‡æœ¬æç¤º
          const indicator = document.createElement("span");
          indicator.className = "favorite-indicator";
          indicator.innerHTML = "Apple Music å–œæ¬¢";
          indicator.title = "Apple Music å–œæ¬¢";
          indicatorsContainer.appendChild(indicator);
        } else if (lastFmFav) {
          // åªæœ‰Last.fmå–œæ¬¢ï¼Œæ˜¾ç¤ºæ–‡æœ¬æç¤º
          const indicator = document.createElement("span");
          indicator.className = "favorite-indicator";
          indicator.innerHTML = "Last.fm å–œæ¬¢";
          indicator.title = "Last.fm å–œæ¬¢";
          indicatorsContainer.appendChild(indicator);
        }
        // å¦‚æœä¸¤ä¸ªéƒ½ä¸å–œæ¬¢ï¼Œåˆ™ä¸æ˜¾ç¤ºä»»ä½•æŒ‡ç¤ºå™¨
      }

      // æ›´æ–°ç‚¹èµæŒ‰é’®çŠ¶æ€
      function updateFavoriteButtonState(isLiked) {
        const favoriteButton = document.getElementById("favoriteButton");
        if (isLiked) {
          favoriteButton.innerHTML = "â˜…";
          favoriteButton.className = "favorite-button liked";
          favoriteButton.title = "å·²æ·»åŠ åˆ°å–œæ¬¢";
        } else {
          favoriteButton.innerHTML = "â­ï¸";
          favoriteButton.className = "favorite-button unliked";
          favoriteButton.title = "æ·»åŠ åˆ°å–œæ¬¢";
        }
      }

      // ç‚¹èµæŒ‰é’®ç‚¹å‡»äº‹ä»¶å¤„ç†
      function handleFavoriteButtonClick() {
        if (!currentTrackInfo || !currentSource) {
          console.log("æ²¡æœ‰æ­£åœ¨æ’­æ”¾çš„æ›²ç›®");
          return;
        }

        const favoriteButton = document.getElementById("favoriteButton");
        const isCurrentlyLiked = favoriteButton.classList.contains("liked");

        // å¦‚æœå·²ç»æ”¶è—ï¼Œåˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
        if (isCurrentlyLiked) {
          return;
        }

        // ç«‹å³æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼Œæä¾›å³æ—¶åé¦ˆ
        updateFavoriteButtonState(!isCurrentlyLiked);

        // å‘é€è¯·æ±‚åˆ°åç«¯å¤„ç†æ”¶è—é€»è¾‘
        fetch(API_BASE_URL + "/api/favorite", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            artist: currentTrackInfo.artist,
            album: currentTrackInfo.album,
            track: currentTrackInfo.title,
            source: currentSource,
            favorite: !isCurrentlyLiked,
          }),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("ç½‘ç»œå“åº”é”™è¯¯");
            }
            return response.json();
          })
          .then((data) => {
            // æ›´æ–°å–œæ¬¢çŠ¶æ€æŒ‡ç¤ºå™¨
            updateFavoriteIndicators(data.apple_music, data.lastfm);
            // æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼ˆä»¥é˜²åç«¯è¿”å›çš„çŠ¶æ€ä¸å‰ç«¯ä¸ä¸€è‡´ï¼‰
            updateFavoriteButtonState(data.apple_music);
          })
          .catch((error) => {
            console.error("æ”¶è—æ“ä½œå¤±è´¥:", error);
            // æ¢å¤æŒ‰é’®åŸå§‹çŠ¶æ€
            updateFavoriteButtonState(isCurrentlyLiked);
            alert("æ”¶è—æ“ä½œå¤±è´¥: " + error.message);
          });
      }

      // åˆå§‹åŒ–æ­£åœ¨æ’­æ”¾æ‚¬æµ®çª—çš„æ‹–åŠ¨å’Œç¼©å°åŠŸèƒ½
      function initNowPlayingDrag() {
        const nowPlaying = document.getElementById("nowPlaying");
        const header = document.querySelector(".now-playing-header");
        const minimizeHandle = document.querySelector(".minimize-handle");

        if (!nowPlaying || !header || !minimizeHandle) return;

        let isDragging = false;
        let offsetX, offsetY;
        let originalX, originalY;

        // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶ï¼ˆæ‹–åŠ¨ï¼‰- åœ¨æ•´ä¸ªæ ‡é¢˜æ éƒ½å¯ä»¥è§¦å‘
        header.addEventListener("mousedown", function (e) {
          // å¦‚æœç‚¹å‡»çš„æ˜¯ç¼©å°æŒ‰é’®ï¼Œåˆ™ä¸è§¦å‘æ‹–åŠ¨
          if (e.target === minimizeHandle) return;

          isDragging = true;
          nowPlaying.classList.add("dragging");

          // è·å–æ‚¬æµ®çª—å½“å‰ä½ç½®
          const rect = nowPlaying.getBoundingClientRect();
          originalX = rect.left;
          originalY = rect.top;

          // è®¡ç®—é¼ æ ‡ç›¸å¯¹äºæ‚¬æµ®çª—çš„ä½ç½®
          offsetX = e.clientX - originalX;
          offsetY = e.clientY - originalY;

          // é˜²æ­¢æ–‡æœ¬é€‰æ‹©
          e.preventDefault();
        });

        // é¼ æ ‡ç§»åŠ¨äº‹ä»¶ï¼ˆæ‹–åŠ¨ï¼‰
        document.addEventListener("mousemove", function (e) {
          if (!isDragging) return;

          // è®¡ç®—æ‚¬æµ®çª—çš„æ–°ä½ç½®
          const x = e.clientX - offsetX;
          const y = e.clientY - offsetY;

          // è®¾ç½®æ‚¬æµ®çª—ä½ç½®
          nowPlaying.style.left = x + "px";
          nowPlaying.style.top = y + "px";
          nowPlaying.style.right = "auto";
        });

        // é¼ æ ‡é‡Šæ”¾äº‹ä»¶ï¼ˆæ‹–åŠ¨ï¼‰
        document.addEventListener("mouseup", function () {
          isDragging = false;
          nowPlaying.classList.remove("dragging");
        });

        // ç‚¹å‡»ç¼©å°/å±•å¼€æŒ‰é’®
        minimizeHandle.addEventListener("click", function () {
          nowPlaying.classList.toggle("minimized");
        });
      }

      // åˆå§‹åŒ–ç»Ÿè®¡å¡ç‰‡
      function initStats() {
        fetch(API_BASE_URL + "/api/dashboard/stats")
          .then((response) => {
            if (!response.ok) {
              throw new Error("ç½‘ç»œå“åº”é”™è¯¯");
            }
            return response.json();
          })
          .then((data) => {
            document.getElementById("totalPlays").textContent =
              data.totalPlays.toLocaleString();
            document.getElementById("totalTracks").textContent =
              data.totalTracks.toLocaleString();
            document.getElementById("totalArtists").textContent =
              data.totalArtists.toLocaleString();
            document.getElementById("totalAlbums").textContent =
              data.totalAlbums.toLocaleString();
          })
          .catch((error) => {
            console.error("è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥:", error);
            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            document.getElementById("totalPlays").textContent = "é”™è¯¯";
            document.getElementById("totalTracks").textContent = "é”™è¯¯";
            document.getElementById("totalArtists").textContent = "é”™è¯¯";
            document.getElementById("totalAlbums").textContent = "é”™è¯¯";
          });
      }

      // å…¨å±€å˜é‡å­˜å‚¨æ’­æ”¾æ¥æºå›¾è¡¨å®ä¾‹
      let sourceChartInstance = null;

      // æœªä¸ŠæŠ¥è®°å½•ç›¸å…³å˜é‡
      let currentUnscrobbledPage = 1;
      const unscrobbledPageSize = 10;
      let totalUnscrobbledRecords = 0;

      // åˆå§‹åŒ–æ’­æ”¾æ¥æºæ‰‡å½¢å›¾
      function initSourceChart() {
        const chartContainer =
          document.getElementById("sourceChart").parentElement;

        // é”€æ¯ä¹‹å‰çš„å›¾è¡¨å®ä¾‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (sourceChartInstance) {
          sourceChartInstance.destroy();
          sourceChartInstance = null;
        }

        // æ¸…ç†å®¹å™¨å¹¶é‡æ–°åˆ›å»ºcanvaså…ƒç´ 
        chartContainer.innerHTML = '<canvas id="sourceChart"></canvas>';
        const canvas = document.getElementById("sourceChart");
        if (!canvas) {
          console.error("æ‰¾ä¸åˆ°IDä¸ºsourceChartçš„canvaså…ƒç´ ");
          return;
        }

        const ctx = canvas.getContext("2d");

        // ä»åç«¯è·å–æ•°æ®
        fetch(API_BASE_URL + "/api/dashboard/play-counts-by-source")
          .then((response) => {
            if (!response.ok) {
              throw new Error("ç½‘ç»œå“åº”é”™è¯¯");
            }
            return response.json();
          })
          .then((data) => {
            // è·å–æš—è‰²æ¨¡å¼é…ç½®
            const darkModeOptions = getChartDarkModeOptions();

            // å¤„ç†æ•°æ®
            const sources = Object.keys(data);
            const counts = sources.map((source) => data[source]);

            // å®šä¹‰é¢œè‰²
            const backgroundColors = [
              "rgba(231, 76, 60, 0.7)", // Apple Music - çº¢è‰²
              "rgba(155, 89, 182, 0.7)", // Audirvana - ç´«è‰²
              "rgba(127, 140, 141, 0.7)", // Roon - ç°è‰²
              "rgba(52, 152, 219, 0.7)", // å…¶ä»– - è“è‰²
            ];

            const borderColors = [
              "rgba(231, 76, 60, 1)",
              "rgba(155, 89, 182, 1)",
              "rgba(127, 140, 141, 1)",
              "rgba(52, 152, 219, 1)",
            ];

            // åˆ›å»ºæ‰‡å½¢å›¾å¹¶ä¿å­˜å®ä¾‹
            sourceChartInstance = new Chart(ctx, {
              type: "doughnut",
              data: {
                labels: sources,
                datasets: [
                  {
                    data: counts,
                    backgroundColor: backgroundColors.slice(0, sources.length),
                    borderColor: borderColors.slice(0, sources.length),
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: "right",
                    labels: {
                      color: darkModeOptions.color, // æš—è‰²æ¨¡å¼ä¸‹çš„å›¾ä¾‹æ–‡å­—é¢œè‰²
                      boxWidth: 12,
                      padding: 8,
                      font: {
                        size: 12,
                      },
                    },
                  },
                  tooltip: {
                    callbacks: {
                      label: function (context) {
                        const label = context.label || "";
                        const value = context.raw || 0;
                        const total = context.dataset.data.reduce(
                          (a, b) => a + b,
                          0
                        );
                        const percentage = Math.round((value / total) * 100);
                        return `${label}: ${value} (${percentage}%)`;
                      },
                    },
                  },
                },
                cutout: "60%",
              },
            });
          })
          .catch((error) => {
            console.error("è·å–æ’­æ”¾æ¥æºæ•°æ®å¤±è´¥:", error);
            // é”€æ¯ä¹‹å‰çš„å›¾è¡¨å®ä¾‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (sourceChartInstance) {
              sourceChartInstance.destroy();
              sourceChartInstance = null;
            }
            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            const chartContainer =
              document.getElementById("sourceChart").parentElement;
            chartContainer.innerHTML =
              '<div class="error">åŠ è½½å¤±è´¥: ' + error.message + "</div>";
          });
      }

      // å…¨å±å…ƒç´ å’ŒçŠ¶æ€
      let isTrendChartFullscreen = false;
      let originalChartContainer = null;
      let originalChartParent = null;
      let originalChartStyle = null;

      // åˆ‡æ¢è¶‹åŠ¿å›¾å…¨å±æ˜¾ç¤º
      function toggleTrendChartFullscreen() {
        const chartContainer =
          document.querySelector("#trendChart").parentElement;
        const fullscreenBtn = document.getElementById(
          "trendChartFullscreenBtn"
        );

        if (!isTrendChartFullscreen) {
          // è¿›å…¥å…¨å±æ¨¡å¼
          // ä¿å­˜åŸå§‹çˆ¶å…ƒç´ å’Œæ ·å¼
          originalChartParent = chartContainer.parentElement;
          originalChartStyle = {
            width: chartContainer.style.width,
            height: chartContainer.style.height,
            position: chartContainer.style.position,
            zIndex: chartContainer.style.zIndex,
          };

          // åˆ›å»ºå…¨å±é®ç½©
          const fullscreenOverlay = document.createElement("div");
          fullscreenOverlay.id = "trendChartFullscreenOverlay";
          fullscreenOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
          `;

          // åˆ›å»ºå…³é—­æŒ‰é’®
          const closeBtn = document.createElement("button");
          closeBtn.innerHTML = "Ã—";
          closeBtn.style.cssText = `
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 36px;
            cursor: pointer;
            z-index: 10001;
          `;

          closeBtn.addEventListener("click", function () {
            toggleTrendChartFullscreen();
          });

          // åˆ›å»ºåŒ…å«å›¾è¡¨çš„å®¹å™¨
          const chartWrapper = document.createElement("div");
          // æ ¹æ®å½“å‰ä¸»é¢˜è®¾ç½®èƒŒæ™¯è‰²
          const isDark = document.body.classList.contains("dark-mode");
          const backgroundColor = isDark ? "#2c2c2c" : "white";
          const textColor = isDark ? "#f0f0f0" : "#2c3e50";
          chartWrapper.style.cssText = `
            width: 90%;
            height: 90%;
            background-color: ${backgroundColor};
            border-radius: 8px;
            padding: 20px;
            color: ${textColor};
          `;

          // å°†å›¾è¡¨ç§»åŠ¨åˆ°æ–°å®¹å™¨ä¸­
          chartContainer.style.width = "100%";
          chartContainer.style.height = "100%";
          chartWrapper.appendChild(chartContainer);
          fullscreenOverlay.appendChild(chartWrapper);
          fullscreenOverlay.appendChild(closeBtn);
          document.body.appendChild(fullscreenOverlay);

          // æ›´æ–°æŒ‰é’®æ–‡æœ¬
          fullscreenBtn.textContent = "é€€å‡ºå…¨å±";

          // æ ‡è®°ä¸ºå…¨å±çŠ¶æ€
          isTrendChartFullscreen = true;

          // é‡æ–°æ¸²æŸ“å›¾è¡¨ä»¥é€‚åº”æ–°å°ºå¯¸
          if (window.trendChartInstance) {
            window.trendChartInstance.resize();
          }
        } else {
          // é€€å‡ºå…¨å±æ¨¡å¼
          // ç§»é™¤å…¨å±é®ç½©
          const fullscreenOverlay = document.getElementById(
            "trendChartFullscreenOverlay"
          );
          if (fullscreenOverlay) {
            // å°†å›¾è¡¨ç§»å›åŸå§‹ä½ç½®
            const chartWrapper = fullscreenOverlay.querySelector("div");
            if (chartWrapper) {
              originalChartParent.appendChild(chartContainer);
            }

            // æ¢å¤åŸå§‹æ ·å¼
            chartContainer.style.width = originalChartStyle.width || "";
            chartContainer.style.height = originalChartStyle.height || "";
            chartContainer.style.position = originalChartStyle.position || "";
            chartContainer.style.zIndex = originalChartStyle.zIndex || "";

            // ç§»é™¤é®ç½©
            document.body.removeChild(fullscreenOverlay);
          }

          // æ›´æ–°æŒ‰é’®æ–‡æœ¬
          fullscreenBtn.textContent = "å…¨å±";

          // æ ‡è®°ä¸ºéå…¨å±çŠ¶æ€
          isTrendChartFullscreen = false;

          // é‡æ–°æ¸²æŸ“å›¾è¡¨ä»¥é€‚åº”åŸå§‹å°ºå¯¸
          if (window.trendChartInstance) {
            window.trendChartInstance.resize();
          }
        }
      }

      // åˆå§‹åŒ–è¶‹åŠ¿å›¾
      function initTrendChart(range = 30) {
        const ctx = document.getElementById("trendChart").getContext("2d");

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const chartContainer =
          document.querySelector("#trendChart").parentElement;
        chartContainer.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

        // é‡æ–°åˆ›å»ºcanvaså…ƒç´ 
        const canvas = document.createElement("canvas");
        canvas.id = "trendChart";
        chartContainer.appendChild(canvas);
        const newCtx = canvas.getContext("2d");

        // ä»åç«¯è·å–æ•°æ®ï¼Œæ·»åŠ æ—¶é—´èŒƒå›´å‚æ•°
        fetch(`${API_BASE_URL}/api/dashboard/trend?range=${range}`)
          .then((response) => {
            if (!response.ok) {
              throw new Error("ç½‘ç»œå“åº”é”™è¯¯");
            }
            return response.json();
          })
          .then((data) => {
            // ç§»é™¤åŠ è½½çŠ¶æ€
            const loadingElement = chartContainer.querySelector(".loading");
            if (loadingElement) {
              loadingElement.remove();
            }

            // è·å–æš—è‰²æ¨¡å¼é…ç½®
            const darkModeOptions = getChartDarkModeOptions();

            // å¤„ç†æ–°çš„APIå“åº”æ ¼å¼ï¼Œå°†æ•°æ®è½¬æ¢ä¸ºæ°”æ³¡å›¾æ‰€éœ€æ ¼å¼
            const bubbleData = [];
            // å­˜å‚¨æ¯å¤©çš„æ€»æ’­æ”¾æ¬¡æ•°ï¼Œç”¨äºtooltipæ˜¾ç¤º
            const dailyTotals = {};

            // éå†hourlyæ•°æ®ç”Ÿæˆæ°”æ³¡å›¾æ•°æ®ç‚¹
            Object.keys(data.hourly).forEach((date) => {
              const hourlyData = data.hourly[date];
              // è®¡ç®—å½“å¤©æ€»æ’­æ”¾æ¬¡æ•°
              dailyTotals[date] = hourlyData.total;

              Object.keys(hourlyData.hourly).forEach((hour) => {
                const playCount = hourlyData.hourly[hour];
                // åªæœ‰æ’­æ”¾æ¬¡æ•°å¤§äº0çš„æ•°æ®æ‰æ˜¾ç¤º
                if (playCount > -1) {
                  // ç¡®ä¿æ—¥æœŸæ ¼å¼æ­£ç¡®ï¼Œä½¿ç”¨Dateæ„é€ å‡½æ•°è§£ææ—¥æœŸå­—ç¬¦ä¸²
                  const dateObj = new Date(date);
                  // è°ƒæ•´åˆ°å½“å¤©çš„ä¸­åˆ12:00ï¼Œé¿å…æ—¶åŒºé—®é¢˜å¯¼è‡´çš„æ—¥æœŸåç§»
                  dateObj.setHours(12, 0, 0, 0);
                  bubbleData.push({
                    x: dateObj, // ä½¿ç”¨Dateå¯¹è±¡è€Œä¸æ˜¯æ—¶é—´æˆ³
                    y: parseInt(hour), // å°æ—¶ï¼ˆ0-23ï¼‰
                    r: playCount, // æ’­æ”¾æ¬¡æ•°ä½œä¸ºæ°”æ³¡åŠå¾„
                    date: date, // æ·»åŠ åŸå§‹æ—¥æœŸå­—ç¬¦ä¸²ç”¨äºtooltip
                  });
                }
              });
            });

            // è®¡ç®—æ‰€æœ‰æ•°æ®ç‚¹ä¸­çš„æœ€å¤§æ’­æ”¾æ¬¡æ•°ï¼Œç”¨äºé¢œè‰²æ˜ å°„
            let maxPlayCount = 0;
            bubbleData.forEach((point) => {
              if (point.r > maxPlayCount) {
                maxPlayCount = point.r;
              }
            });

            // é¢œè‰²æ’å€¼å‡½æ•°ï¼šæ’­æ”¾æ¬¡æ•°å¤šä¸ºæš–è‰²(çº¢è‰²)ï¼Œæ’­æ”¾æ¬¡æ•°å°‘ä¸ºå†·è‰²(è“è‰²)
            function getColorForCount(count, maxCount) {
              // å½’ä¸€åŒ–å€¼ (0-1)
              const normalized = maxCount > 0 ? count / maxCount : 0;

              // æš–è‰²åˆ°å†·è‰²çš„æ¸å˜
              // çº¢è‰² (255, 0, 0) åˆ° è“è‰² (0, 0, 255)
              // åè½¬é€»è¾‘ï¼šæ’­æ”¾æ¬¡æ•°å¤šæ˜¾ç¤ºçº¢è‰²ï¼Œæ’­æ”¾æ¬¡æ•°å°‘æ˜¾ç¤ºè“è‰²
              const r = Math.round(255 * normalized);
              const g = 20;
              const b = Math.round(255 * (1 - normalized));

              return {
                background: `rgba(${r}, ${g}, ${b}, 0.4)`,
                border: `rgba(${r}, ${g}, ${b}, 1)`,
              };
            }

            // ä¿å­˜å›¾è¡¨å®ä¾‹ä»¥ä¾¿å…¨å±æ—¶é‡æ–°æ¸²æŸ“
            window.trendChartInstance = new Chart(newCtx, {
              type: "bubble",
              data: {
                datasets: [
                  {
                    label: "æ’­æ”¾è®°å½•",
                    data: bubbleData,
                    backgroundColor: function (context) {
                      const count = context.raw.r;
                      return getColorForCount(count, maxPlayCount).background;
                    },
                    borderColor: function (context) {
                      const count = context.raw.r;
                      return getColorForCount(count, maxPlayCount).border;
                    },
                    borderWidth: 1,
                    pointStyle: "circle",
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false,
                    labels: {
                      color: darkModeOptions.color, // æš—è‰²æ¨¡å¼ä¸‹çš„å›¾ä¾‹æ–‡å­—é¢œè‰²
                    },
                  },
                  tooltip: {
                    callbacks: {
                      title: function (context) {
                        // æ˜¾ç¤ºæ—¥æœŸå’Œæ—¶é—´
                        const point = context[0].raw;
                        const date = new Date(point.x);
                        const dateString = `${date.getFullYear()}-${(
                          date.getMonth() + 1
                        )
                          .toString()
                          .padStart(2, "0")}-${date
                          .getDate()
                          .toString()
                          .padStart(2, "0")}`;
                        const dailyTotal = dailyTotals[point.date] || 0;
                        return `${dateString} ${point.y
                          .toString()
                          .padStart(2, "0")}:00 ( å½“æ—¥æ€»è®¡: ${dailyTotal} )`;
                      },
                      label: function (context) {
                        return `æ’­æ”¾æ¬¡æ•°: ${context.raw.r}`;
                      },
                    },
                  },
                },
                scales: {
                  x: {
                    type: "time",
                    time: {
                      unit: "day",
                      tooltipFormat: "yyyy-MM-dd",
                      displayFormats: {
                        day: "MM-dd",
                      },
                      // ç¡®ä¿æ—¶é—´è½´ä»æ•°æ®çš„æœ€å°å€¼å¼€å§‹
                      minUnit: "day",
                    },
                    title: {
                      display: true,
                      text: "æ—¥æœŸ",
                      color: darkModeOptions.color, // æš—è‰²æ¨¡å¼ä¸‹çš„æ ‡é¢˜é¢œè‰²
                    },
                    grid: {
                      color: darkModeOptions.gridColor, // æš—è‰²æ¨¡å¼ä¸‹çš„ç½‘æ ¼çº¿é¢œè‰²
                    },
                    ticks: {
                      color: darkModeOptions.ticksColor, // æš—è‰²æ¨¡å¼ä¸‹çš„åˆ»åº¦é¢œè‰²
                      //stepSize: 1,
                      maxRotation: 60,
                      minRotation: 45,
                      autoSkip: true,
                      // ç¡®ä¿æ ‡ç­¾ä¸æ•°æ®ç‚¹å¯¹é½
                      source: "data",
                      // ç¡®ä¿æ ‡ç­¾ä¸æ•°æ®ç‚¹å¯¹é½
                      align: "center",
                    },
                    // æ·»åŠ è¾¹ç•Œè®¾ç½®ä»¥ç¡®ä¿æ•°æ®ç‚¹å®Œå…¨æ˜¾ç¤º
                    bounds: "data",
                  },
                  y: {
                    type: "linear",
                    min: -1,
                    max: 24.99,
                    ticks: {
                      color: darkModeOptions.ticksColor, // æš—è‰²æ¨¡å¼ä¸‹çš„åˆ»åº¦é¢œè‰²
                      stepSize: 1,
                      maxRotation: 60,
                      minRotation: 45,
                      callback: function (value) {
                        // æ˜¾ç¤ºå°æ—¶æ ¼å¼ (HH:00)
                        return `${value.toString().padStart(2, "0")}:00`;
                      },
                    },
                    title: {
                      display: true,
                      text: "æ—¶é—´",
                      color: darkModeOptions.color, // æš—è‰²æ¨¡å¼ä¸‹çš„æ ‡é¢˜é¢œè‰²
                    },
                    grid: {
                      color: darkModeOptions.gridColor, // æš—è‰²æ¨¡å¼ä¸‹çš„ç½‘æ ¼çº¿é¢œè‰²
                    },
                  },
                },
                elements: {
                  point: {
                    radius: function (context) {
                      // æ ¹æ®æ•°æ®ç‚¹çš„ r å€¼è°ƒæ•´åŠå¾„ï¼Œæ·»åŠ ç¼©æ”¾å› å­æ¥è°ƒæ•´å¤§å°
                      const radius = context.raw.r;
                      return Math.max(radius * 3, 2); // æœ€å°åŠå¾„ä¸º2
                    },
                  },
                },
              },
            });
          })
          .catch((error) => {
            console.error("è·å–è¶‹åŠ¿å›¾æ•°æ®å¤±è´¥:", error);
            // ç§»é™¤åŠ è½½çŠ¶æ€
            const loadingElement = chartContainer.querySelector(".loading");
            if (loadingElement) {
              loadingElement.remove();
            }
            // é”€æ¯ä¹‹å‰çš„å›¾è¡¨å®ä¾‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (window.trendChartInstance) {
              window.trendChartInstance.destroy();
              window.trendChartInstance = null;
            }
            // ç¡®ä¿canvaså…ƒç´ å­˜åœ¨åå†æ›¿æ¢innerHTML
            const canvas = document.getElementById("trendChart");
            if (canvas && canvas.parentElement) {
              canvas.parentElement.innerHTML =
                '<div class="error">åŠ è½½å¤±è´¥: ' + error.message + "</div>";
            }
          });
      }

      // åˆå§‹åŒ–è‰ºæœ¯å®¶å›¾è¡¨
      function initArtistChart(type = "plays") {
        const ctx = document.getElementById("artistChart").getContext("2d");

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const chartContainer =
          document.querySelector("#artistChart").parentElement;
        chartContainer.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

        // é‡æ–°åˆ›å»ºcanvaså…ƒç´ 
        const canvas = document.createElement("canvas");
        canvas.id = "artistChart";
        chartContainer.appendChild(canvas);
        const newCtx = canvas.getContext("2d");

        // æ ¹æ®ç±»å‹é€‰æ‹©ä¸åŒçš„APIç«¯ç‚¹
        const apiUrl =
          type === "plays"
            ? API_BASE_URL + "/api/dashboard/top-artists/plays?limit=10"
            : API_BASE_URL + "/api/dashboard/top-artists/tracks?limit=10";

        // ä»åç«¯è·å–æ•°æ®
        fetch(apiUrl)
          .then((response) => {
            if (!response.ok) {
              throw new Error("ç½‘ç»œå“åº”é”™è¯¯");
            }
            return response.json();
          })
          .then((data) => {
            // ç§»é™¤åŠ è½½çŠ¶æ€
            const loadingElement = chartContainer.querySelector(".loading");
            if (loadingElement) {
              loadingElement.remove();
            }

            // å¤„ç†æ•°æ®
            const artists = data.map((item) => item.artist);
            const counts = data.map((item) =>
              type === "plays" ? item.play_count : item.track_count
            );

            const label = type === "plays" ? "æ’­æ”¾æ¬¡æ•°" : "æ›²ç›®æ•°";

            // è·å–æš—è‰²æ¨¡å¼é…ç½®
            const darkModeOptions = getChartDarkModeOptions();

            new Chart(newCtx, {
              type: "bar",
              data: {
                labels: artists,
                datasets: [
                  {
                    label: label,
                    data: counts,
                    /* backgroundColor: [
                            "rgba(52, 152, 219, 0.7)",
                            "rgba(46, 204, 113, 0.7)",
                            "rgba(231, 76, 60, 0.7)",
                            "rgba(155, 89, 182, 0.7)",
                            "rgba(241, 196, 15, 0.7)",
                            "rgba(52, 152, 219, 0.7)",
                            "rgba(46, 204, 113, 0.7)",
                            "rgba(231, 76, 60, 0.7)",
                            "rgba(155, 89, 182, 0.7)",
                            "rgba(241, 196, 15, 0.7)",
                          ],
                          borderColor: [
                            "rgba(52, 152, 219, 1)",
                            "rgba(46, 204, 113, 1)",
                            "rgba(231, 76, 60, 1)",
                            "rgba(155, 89, 182, 1)",
                            "rgba(241, 196, 15, 1)",
                            "rgba(52, 152, 219, 1)",
                            "rgba(46, 204, 113, 1)",
                            "rgba(231, 76, 60, 1)",
                            "rgba(155, 89, 182, 1)",
                            "rgba(241, 196, 15, 1)",
                          ], */
                    /* backgroundColor: [
                            "rgba(231, 76, 60, 0.9)", // 1 çº¢
                            "rgba(230, 126, 34, 0.9)", // 2 æ©™
                            "rgba(241, 196, 15, 0.9)", // 3 é»„
                            "rgba(46, 204, 113, 0.85)", // 4 ç»¿
                            "rgba(0, 90, 140, 0.8)", // 5 é›è“
                            "rgba(52, 152, 219, 0.8)", // 6 è“
                            "rgba(110, 40, 140, 0.65)", // 7 æ·±ç´«
                            "rgba(165, 95, 190, 0.7)", // 8 ç´«
                            "rgba(127, 140, 141, 0.6)", // 9 ç°è“
                            "rgba(189, 195, 199, 0.55)", // 10 æµ…ç°æ”¶å°¾
                          ],
                          borderColor: [
                            "rgba(231, 76, 60, 1)",
                            "rgba(230, 126, 34, 1)",
                            "rgba(241, 196, 15, 1)",
                            "rgba(46, 204, 113, 1)",
                            "rgba(52, 152, 219, 1)",
                            "rgba(52, 73, 94, 1)",
                            "rgba(142, 68, 173, 1)",
                            "rgba(155, 89, 182, 1)",
                            "rgba(127, 140, 141, 1)",
                            "rgba(189, 195, 199, 1)",
                          ], */
                    backgroundColor: [
                      "rgba(231, 76, 60, 0.9)", // 1 çº¢
                      "rgba(230, 126, 34, 0.9)", // 2 æ©™
                      "rgba(241, 196, 15, 0.9)", // 3 é»„
                      "rgba(46, 204, 113, 0.85)", // 4 ç»¿
                      "rgba(0, 200, 200, 0.8)", // 5 é’
                      "rgba(52, 152, 219, 0.8)", // 6 è“
                      "rgba(0, 90, 140, 0.75)", // 7 æ·±è“/é›è“
                      "rgba(142, 68, 173, 0.7)", // 8 ç´«
                      "rgba(127, 140, 141, 0.65)", // 9 ç°è“
                      "rgba(189, 195, 199, 0.6)", // 10 æµ…ç°æ”¶å°¾
                    ],
                    borderColor: [
                      "rgba(231, 76, 60, 1)",
                      "rgba(230, 126, 34, 1)",
                      "rgba(241, 196, 15, 1)",
                      "rgba(46, 204, 113, 1)",
                      "rgba(0, 200, 200, 1)",
                      "rgba(52, 152, 219, 1)",
                      "rgba(0, 90, 140, 1)",
                      "rgba(142, 68, 173, 1)",
                      "rgba(127, 140, 141, 1)",
                      "rgba(189, 195, 199, 1)",
                    ],
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false,
                    labels: {
                      color: darkModeOptions.color, // æš—è‰²æ¨¡å¼ä¸‹çš„å›¾ä¾‹æ–‡å­—é¢œè‰²
                    },
                  },
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    grid: {
                      color: darkModeOptions.gridColor, // æš—è‰²æ¨¡å¼ä¸‹çš„ç½‘æ ¼çº¿é¢œè‰²
                    },
                    ticks: {
                      color: darkModeOptions.ticksColor, // æš—è‰²æ¨¡å¼ä¸‹çš„åˆ»åº¦é¢œè‰²
                    },
                  },
                  x: {
                    grid: {
                      display: false,
                    },
                    ticks: {
                      color: darkModeOptions.ticksColor, // æš—è‰²æ¨¡å¼ä¸‹çš„åˆ»åº¦é¢œè‰²
                      autoSkip: false,
                      maxRotation: 45, // æ¢å¤æ–œä½“æ˜¾ç¤º
                      callback: function (value) {
                        // æˆªæ–­è¿‡é•¿çš„æ ‡ç­¾æ–‡æœ¬
                        const label = this.getLabelForValue(value);
                        if (label && label.length > 15) {
                          return label.substring(0, 15) + "...";
                        }
                        return label;
                      },
                    },
                  },
                },
              },
            });
          })
          .catch((error) => {
            console.error("è·å–è‰ºæœ¯å®¶æ•°æ®å¤±è´¥:", error);
            // ç§»é™¤åŠ è½½çŠ¶æ€
            const loadingElement = chartContainer.querySelector(".loading");
            if (loadingElement) {
              loadingElement.remove();
            }
            chartContainer.innerHTML =
              '<div class="error">åŠ è½½å¤±è´¥: ' + error.message + "</div>";
          });
      }

      // åˆå§‹åŒ–çƒ­é—¨ä¸“è¾‘å›¾è¡¨
      function initAlbumChart(days = 7) {
        const ctx = document.getElementById("albumChart").getContext("2d");

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const chartContainer =
          document.querySelector("#albumChart").parentElement;
        chartContainer.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

        // é‡æ–°åˆ›å»ºcanvaså…ƒç´ 
        const canvas = document.createElement("canvas");
        canvas.id = "albumChart";
        chartContainer.appendChild(canvas);
        const newCtx = canvas.getContext("2d");

        // ä»åç«¯è·å–æ•°æ®
        fetch(`${API_BASE_URL}/api/dashboard/top-albums?days=${days}&limit=10`)
          .then((response) => {
            if (!response.ok) {
              throw new Error("ç½‘ç»œå“åº”é”™è¯¯");
            }
            return response.json();
          })
          .then((data) => {
            // ç§»é™¤åŠ è½½çŠ¶æ€
            const loadingElement = chartContainer.querySelector(".loading");
            if (loadingElement) {
              loadingElement.remove();
            }

            // å¤„ç†æ•°æ®
            const albums = data.map((item) => item.album);
            const artists = data.map((item) => item.artist);
            const counts = data.map((item) => item.play_count);

            // è·å–æš—è‰²æ¨¡å¼é…ç½®
            const darkModeOptions = getChartDarkModeOptions();

            new Chart(newCtx, {
              type: "bar",
              data: {
                labels: albums,
                datasets: [
                  {
                    label: "æ’­æ”¾æ¬¡æ•°",
                    data: counts,
                    backgroundColor: [
                      "rgba(231, 76, 60, 0.9)", // 1 çº¢
                      "rgba(230, 126, 34, 0.9)", // 2 æ©™
                      "rgba(241, 196, 15, 0.9)", // 3 é»„
                      "rgba(46, 204, 113, 0.85)", // 4 ç»¿
                      "rgba(0, 200, 200, 0.8)", // 5 é’
                      "rgba(52, 152, 219, 0.8)", // 6 è“
                      "rgba(0, 90, 140, 0.75)", // 7 æ·±è“/é›è“
                      "rgba(142, 68, 173, 0.7)", // 8 ç´«
                      "rgba(127, 140, 141, 0.65)", // 9 ç°è“
                      "rgba(189, 195, 199, 0.6)", // 10 æµ…ç°æ”¶å°¾
                    ],
                    borderColor: [
                      "rgba(231, 76, 60, 1)",
                      "rgba(230, 126, 34, 1)",
                      "rgba(241, 196, 15, 1)",
                      "rgba(46, 204, 113, 1)",
                      "rgba(0, 200, 200, 1)",
                      "rgba(52, 152, 219, 1)",
                      "rgba(0, 90, 140, 1)",
                      "rgba(142, 68, 173, 1)",
                      "rgba(127, 140, 141, 1)",
                      "rgba(189, 195, 199, 1)",
                    ],
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                indexAxis: "y", // ğŸ‘ˆ æ°´å¹³æ¡å½¢å›¾
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false,
                    labels: {
                      color: darkModeOptions.color, // æš—è‰²æ¨¡å¼ä¸‹çš„å›¾ä¾‹æ–‡å­—é¢œè‰²
                    },
                  },
                  tooltip: {
                    callbacks: {
                      // ç§»é™¤é»˜è®¤ labelï¼ˆç¬¬ä¸€è¡Œï¼‰
                      /*   label: function () {
                              return null;
                            }, */
                      // ç”¨ title å›è°ƒæ˜¾ç¤ºä¸“è¾‘åï¼ˆç¬¬ä¸€è¡Œï¼‰
                      title: function (ctx) {
                        const index = ctx[0].dataIndex; // tooltipItems æ•°ç»„çš„ç¬¬ 0 ä¸ªå…ƒç´ 
                        const artist = artists[index]; // æ‹¿åˆ°å¯¹åº”ä½œè€…
                        return "ã€Š" + ctx[0].label + `ã€‹- ${artist}`; // ä¸“è¾‘å
                      },
                      // ç”¨ afterLabel å›è°ƒæ˜¾ç¤ºä½œè€… + æ’­æ”¾æ¬¡æ•°ï¼ˆç¬¬äºŒè¡Œï¼‰
                      /* afterLabel: function (ctx) {
                              const artist = artists[ctx.dataIndex];
                              //const count = counts[ctx.dataIndex];
                              return `${artist}`;
                            }, */
                    },
                  },
                },
                scales: {
                  x: {
                    beginAtZero: true,
                    grid: {
                      color: darkModeOptions.gridColor, // æš—è‰²æ¨¡å¼ä¸‹çš„ç½‘æ ¼çº¿é¢œè‰²
                    },
                    ticks: {
                      color: darkModeOptions.ticksColor, // æš—è‰²æ¨¡å¼ä¸‹çš„åˆ»åº¦é¢œè‰²
                    },
                  },
                  y: {
                    grid: { display: false },
                    ticks: {
                      color: darkModeOptions.ticksColor, // æš—è‰²æ¨¡å¼ä¸‹çš„åˆ»åº¦é¢œè‰²
                      autoSkip: false,
                      //maxRotation: 60, // æ¢å¤æ–œä½“æ˜¾ç¤º
                      //minRotation: 45, // æ¢å¤æ–œä½“æ˜¾ç¤º
                      callback: function (value) {
                        const label = this.getLabelForValue(value);
                        if (label && label.length > 15) {
                          return label.substring(0, 15) + "...";
                        }
                        return label;
                      },
                    },
                  },
                },
              },
            });
          })
          .catch((error) => {
            console.error("è·å–ä¸“è¾‘æ•°æ®å¤±è´¥:", error);
            // ç§»é™¤åŠ è½½çŠ¶æ€
            const loadingElement = chartContainer.querySelector(".loading");
            if (loadingElement) {
              loadingElement.remove();
            }
            chartContainer.innerHTML =
              '<div class="error">åŠ è½½å¤±è´¥: ' + error.message + "</div>";
          });
      }

      // å…¨å±å…ƒç´ å’ŒçŠ¶æ€ - å£å‘³æµæ´¾å›¾è¡¨
      let isGenreChartFullscreen = false;
      let originalGenreChartContainer = null;
      let originalGenreChartParent = null;
      let originalGenreChartStyle = null;

      // åˆ‡æ¢å£å‘³æµæ´¾å›¾è¡¨å…¨å±æ˜¾ç¤º
      function toggleGenreChartFullscreen() {
        const chartContainer =
          document.querySelector("#genreChart").parentElement;
        const fullscreenBtn = document.getElementById(
          "genreChartFullscreenBtn"
        );

        if (!isGenreChartFullscreen) {
          // è¿›å…¥å…¨å±æ¨¡å¼
          // ä¿å­˜åŸå§‹çˆ¶å…ƒç´ å’Œæ ·å¼
          originalGenreChartParent = chartContainer.parentElement;
          originalGenreChartStyle = {
            width: chartContainer.style.width,
            height: chartContainer.style.height,
            position: chartContainer.style.position,
            zIndex: chartContainer.style.zIndex,
          };

          // åˆ›å»ºå…¨å±é®ç½©
          const fullscreenOverlay = document.createElement("div");
          fullscreenOverlay.id = "genreChartFullscreenOverlay";
          fullscreenOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
          `;

          // åˆ›å»ºå…³é—­æŒ‰é’®
          const closeBtn = document.createElement("button");
          closeBtn.innerHTML = "Ã—";
          closeBtn.style.cssText = `
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 36px;
            cursor: pointer;
            z-index: 10001;
          `;

          closeBtn.addEventListener("click", function () {
            toggleGenreChartFullscreen();
          });

          // åˆ›å»ºåŒ…å«å›¾è¡¨çš„å®¹å™¨
          const chartWrapper = document.createElement("div");
          // æ ¹æ®å½“å‰ä¸»é¢˜è®¾ç½®èƒŒæ™¯è‰²
          const isDark = document.body.classList.contains("dark-mode");
          const backgroundColor = isDark ? "#2c2c2c" : "white";
          const textColor = isDark ? "#f0f0f0" : "#2c3e50";
          chartWrapper.style.cssText = `
            width: 90%;
            height: 90%;
            background-color: ${backgroundColor};
            border-radius: 8px;
            padding: 20px;
            color: ${textColor};
          `;

          // å°†å›¾è¡¨ç§»åŠ¨åˆ°æ–°å®¹å™¨ä¸­
          chartContainer.style.width = "100%";
          chartContainer.style.height = "100%";
          chartWrapper.appendChild(chartContainer);
          fullscreenOverlay.appendChild(chartWrapper);
          fullscreenOverlay.appendChild(closeBtn);
          document.body.appendChild(fullscreenOverlay);

          // æ›´æ–°æŒ‰é’®æ–‡æœ¬
          fullscreenBtn.textContent = "é€€å‡ºå…¨å±";

          // æ ‡è®°ä¸ºå…¨å±çŠ¶æ€
          isGenreChartFullscreen = true;

          // é‡æ–°æ¸²æŸ“å›¾è¡¨ä»¥é€‚åº”æ–°å°ºå¯¸
          if (window.genreChartInstance) {
            window.genreChartInstance.resize();
          }
        } else {
          // é€€å‡ºå…¨å±æ¨¡å¼
          // ç§»é™¤å…¨å±é®ç½©
          const fullscreenOverlay = document.getElementById(
            "genreChartFullscreenOverlay"
          );
          if (fullscreenOverlay) {
            // å°†å›¾è¡¨ç§»å›åŸå§‹ä½ç½®
            const chartWrapper = fullscreenOverlay.querySelector("div");
            if (chartWrapper) {
              originalGenreChartParent.appendChild(chartContainer);
            }

            // æ¢å¤åŸå§‹æ ·å¼
            chartContainer.style.width = originalGenreChartStyle.width || "";
            chartContainer.style.height = originalGenreChartStyle.height || "";
            chartContainer.style.position =
              originalGenreChartStyle.position || "";
            chartContainer.style.zIndex = originalGenreChartStyle.zIndex || "";

            // ç§»é™¤é®ç½©
            document.body.removeChild(fullscreenOverlay);
          }

          // æ›´æ–°æŒ‰é’®æ–‡æœ¬
          fullscreenBtn.textContent = "å…¨å±";

          // æ ‡è®°ä¸ºéå…¨å±çŠ¶æ€
          isGenreChartFullscreen = false;

          // é‡æ–°æ¸²æŸ“å›¾è¡¨ä»¥é€‚åº”åŸå§‹å°ºå¯¸
          if (window.genreChartInstance) {
            window.genreChartInstance.resize();
          }
        }
      }

      // åˆå§‹åŒ–çƒ­é—¨æµæ´¾å›¾è¡¨
      function initGenreChart() {
        const ctx = document.getElementById("genreChart").getContext("2d");

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const chartContainer =
          document.querySelector("#genreChart").parentElement;
        chartContainer.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

        // é‡æ–°åˆ›å»ºcanvaså…ƒç´ 
        const canvas = document.createElement("canvas");
        canvas.id = "genreChart";
        chartContainer.appendChild(canvas);
        const newCtx = canvas.getContext("2d");

        // ä»åç«¯è·å–æ•°æ®
        fetch(API_BASE_URL + "/api/dashboard/top-genres?limit=10")
          .then((response) => {
            if (!response.ok) {
              throw new Error("ç½‘ç»œå“åº”é”™è¯¯");
            }
            return response.json();
          })
          .then((data) => {
            // ç§»é™¤åŠ è½½çŠ¶æ€
            const loadingElement = chartContainer.querySelector(".loading");
            if (loadingElement) {
              loadingElement.remove();
            }

            // å¤„ç†æ•°æ®
            const genres = data.map((item) => item.track_genre_name);
            const genresNameZhs = data.map((item) => item.genre_name_zh);
            const counts = data.map((item) => item.track_genre_count);

            // å®šä¹‰é¢œè‰²
            const backgroundColors = [
              "rgba(231, 76, 60, 0.8)", // çº¢
              "rgba(230, 126, 34, 0.8)", // æ©™
              "rgba(241, 196, 15, 0.8)", // é»„
              "rgba(46, 204, 113, 0.8)", // ç»¿
              "rgba(0, 200, 200, 0.8)", // é’
              "rgba(52, 152, 219, 0.8)", // è“
              "rgba(0, 90, 140, 0.8)", // æ·±è“
              "rgba(142, 68, 173, 0.8)", // ç´«
              "rgba(127, 140, 141, 0.8)", // ç°
              "rgba(189, 195, 199, 0.8)", // æµ…ç°
            ];

            const borderColors = [
              "rgba(231, 76, 60, 1)",
              "rgba(230, 126, 34, 1)",
              "rgba(241, 196, 15, 1)",
              "rgba(46, 204, 113, 1)",
              "rgba(0, 200, 200, 1)",
              "rgba(52, 152, 219, 1)",
              "rgba(0, 90, 140, 1)",
              "rgba(142, 68, 173, 1)",
              "rgba(127, 140, 141, 1)",
              "rgba(189, 195, 199, 1)",
            ];

            // åŸå§‹æ•°æ®
            let dataset = genres.map((g, i) => ({
              genre: g,
              count: counts[i],
              bg: backgroundColors[i],
              border: borderColors[i],
              zh: genresNameZhs[i],
            }));

            // Fisher-Yates æ´—ç‰Œç®—æ³•éšæœºæ‰“ä¹±
            for (let i = dataset.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [dataset[i], dataset[j]] = [dataset[j], dataset[i]];
            }

            // æ‹†åˆ†å›æ•°ç»„
            const shuffledGenres = dataset.map((item) => item.genre);
            const shuffledCounts = dataset.map((item) => item.count);
            const shuffledBackgroundColors = dataset.map((item) => item.bg);
            const shuffledBorderColors = dataset.map((item) => item.border);
            const shuffledGenresNameZhs = dataset.map((item) => item.zh);

            // è·å–æš—è‰²æ¨¡å¼é…ç½®
            const darkModeOptions = getChartDarkModeOptions();

            // ä¿å­˜å›¾è¡¨å®ä¾‹ä»¥ä¾¿å…¨å±æ—¶é‡æ–°æ¸²æŸ“
            window.genreChartInstance = new Chart(newCtx, {
              type: "polarArea",
              data: {
                labels: shuffledGenres,
                datasets: [
                  {
                    label: "æ’­æ”¾æ¬¡æ•°",
                    data: shuffledCounts,
                    backgroundColor: shuffledBackgroundColors,
                    borderColor: shuffledBorderColors,
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: "left",
                    labels: {
                      color: darkModeOptions.color, // æš—è‰²æ¨¡å¼ä¸‹çš„å›¾ä¾‹æ–‡å­—é¢œè‰²
                      font: {
                        size: 10, // å­—ä½“å˜å°
                      },
                      boxWidth: 9, // å°æ–¹å—å˜å°
                      padding: 6, // legend é¡¹ä¹‹é—´çš„é—´è·ç¼©å°
                    },
                  },
                  tooltip: {
                    callbacks: {
                      title: function (ctx) {
                        const index = ctx[0].dataIndex;
                        const genre_name_zh = shuffledGenresNameZhs[index];
                        return ctx[0].label + `ï¼ˆ ${genre_name_zh} ï¼‰`;
                      },
                    },
                  },
                },
                scales: {
                  r: {
                    pointLabels: {
                      color: darkModeOptions.color, // æš—è‰²æ¨¡å¼ä¸‹çš„ç‚¹æ ‡ç­¾é¢œè‰²
                      display: true,
                      centerPointLabels: true,
                      font: {
                        size: 8,
                      },
                    },
                    ticks: {
                      color: darkModeOptions.ticksColor, // æš—è‰²æ¨¡å¼ä¸‹çš„åˆ»åº¦é¢œè‰²
                      backdropColor: isDarkMode()
                        ? "rgba(44, 44, 44, 0.8)"
                        : "rgba(0, 0, 0, 0.05)",
                    },
                    // max: Math.max(...shuffledCounts) * 1.1, // æ‰©å¤§ 20% åŠå¾„
                  },
                },
              },
            });
          })
          .catch((error) => {
            console.error("è·å–æµæ´¾æ•°æ®å¤±è´¥:", error);
            // ç§»é™¤åŠ è½½çŠ¶æ€
            const loadingElement = chartContainer.querySelector(".loading");
            if (loadingElement) {
              loadingElement.remove();
            }
            // é”€æ¯ä¹‹å‰çš„å›¾è¡¨å®ä¾‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (window.genreChartInstance) {
              window.genreChartInstance.destroy();
              window.genreChartInstance = null;
            }
            // ç¡®ä¿canvaså…ƒç´ å­˜åœ¨åå†æ›¿æ¢innerHTML
            const canvas = document.getElementById("genreChart");
            if (canvas && canvas.parentElement) {
              canvas.parentElement.innerHTML =
                '<div class="error">åŠ è½½å¤±è´¥: ' + error.message + "</div>";
            }
          });
      }

      // åˆå§‹åŒ–æœ€è¿‘æ’­æ”¾åˆ—è¡¨
      function initRecentPlays() {
        const recentPlaysList = document.getElementById("recentPlaysList");
        recentPlaysList.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

        fetch(API_BASE_URL + "/api/recent-plays?limit=10")
          .then((response) => {
            if (!response.ok) {
              throw new Error("ç½‘ç»œå“åº”é”™è¯¯");
            }
            return response.json();
          })
          .then((data) => {
            // ç§»é™¤åŠ è½½çŠ¶æ€
            const loadingElement = recentPlaysList.querySelector(".loading");
            if (loadingElement) {
              loadingElement.remove();
            }

            if (data.length === 0) {
              recentPlaysList.innerHTML = '<div class="loading">æš‚æ— æ•°æ®</div>';
              return;
            }

            data.forEach((item, index) => {
              const rankingItem = document.createElement("li");
              rankingItem.className = "ranking-item";

              const playTime = new Date(item.play_time);
              const timeString = playTime.toLocaleTimeString("zh-CN", {
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
              });

              // æ ¹æ®æ¥æºè®¾ç½®æ ·å¼
              let sourceClass = "";
              let sourceText = "";
              switch (item.source?.toLowerCase()) {
                case "apple music":
                  sourceClass = "source-applemusic";
                  sourceText = "AppleMusic";
                  break;
                case "audirvana":
                case "au":
                  sourceClass = "source-audirvana";
                  sourceText = "Audirvana";
                  break;
                case "roon":
                  sourceClass = "source-roon";
                  sourceText = "Roon";
                  break;
                default:
                  sourceClass = "";
                  sourceText = item.source || "Unknown";
              }

              rankingItem.innerHTML = `
                                  <div class="rank-number rank-other">${
                                    index + 1
                                  }</div>
                                  <div class="track-info">
                                      <div class="track-title">${
                                        item.track
                                      }</div>
                                      <div class="track-artist">${
                                        item.artist
                                      } - ${item.album}</div>
                                  </div>
                                  <div style="display: flex; flex-direction: column; align-items: flex-end; margin-left: 10px;">
                                    <div class="play-source ${sourceClass}">${sourceText}</div>
                                    <div class="play-count">${timeString}</div>
                                  </div>
                              `;

              // æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†
              rankingItem.addEventListener('click', function() {
                showTrackDetails(item.artist, item.album, item.track);
              });
              rankingItem.style.cursor = 'pointer';

              recentPlaysList.appendChild(rankingItem);
            });

            // è°ƒæ•´ä¸¤ä¸ªåˆ—è¡¨çš„é«˜åº¦
            adjustRankingListsHeight();
          })
          .catch((error) => {
            console.error("è·å–æœ€è¿‘æ’­æ”¾æ•°æ®å¤±è´¥:", error);
            // ç§»é™¤åŠ è½½çŠ¶æ€
            const loadingElement = recentPlaysList.querySelector(".loading");
            if (loadingElement) {
              loadingElement.remove();
            }
            recentPlaysList.innerHTML =
              '<div class="error">åŠ è½½å¤±è´¥: ' + error.message + "</div>";
          });
      }

      // å®šæœŸåˆ·æ–°æœ€è¿‘æ’­æ”¾åˆ—è¡¨
      function refreshRecentPlays() {
        const recentPlaysList = document.getElementById("recentPlaysList");

        fetch(API_BASE_URL + "/api/recent-plays?limit=10")
          .then((response) => {
            if (!response.ok) {
              throw new Error("ç½‘ç»œå“åº”é”™è¯¯");
            }
            return response.json();
          })
          .then((data) => {
            recentPlaysList.innerHTML = "";

            if (data.length === 0) {
              recentPlaysList.innerHTML = '<div class="loading">æš‚æ— æ•°æ®</div>';
              return;
            }

            data.forEach((item, index) => {
              const rankingItem = document.createElement("li");
              rankingItem.className = "ranking-item";

              const playTime = new Date(item.play_time);
              const timeString = playTime.toLocaleTimeString("zh-CN", {
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
              });

              // æ ¹æ®æ¥æºè®¾ç½®æ ·å¼
              let sourceClass = "";
              let sourceText = "";
              switch (item.source?.toLowerCase()) {
                case "apple music":
                  sourceClass = "source-applemusic";
                  sourceText = "AppleMusic";
                  break;
                case "audirvana":
                case "au":
                  sourceClass = "source-audirvana";
                  sourceText = "Audirvana";
                  break;
                case "roon":
                  sourceClass = "source-roon";
                  sourceText = "Roon";
                  break;
                default:
                  sourceClass = "";
                  sourceText = item.source || "Unknown";
              }

              rankingItem.innerHTML = `
                                  <div class="rank-number rank-other">${
                                    index + 1
                                  }</div>
                                  <div class="track-info">
                                      <div class="track-title">${
                                        item.track
                                      }</div>
                                      <div class="track-artist">${
                                        item.artist
                                      } - ${item.album}</div>
                                  </div>
                                  <div style="display: flex; flex-direction: column; align-items: flex-end; margin-left: 10px;">
                                    <div class="play-source ${sourceClass}">${sourceText}</div>
                                    <div class="play-count">${timeString}</div>
                                  </div>
                              `;

              // æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†
              rankingItem.addEventListener('click', function() {
                showTrackDetails(item.artist, item.album, item.track);
              });
              rankingItem.style.cursor = 'pointer';

              recentPlaysList.appendChild(rankingItem);
            });

            // è°ƒæ•´ä¸¤ä¸ªåˆ—è¡¨çš„é«˜åº¦
            adjustRankingListsHeight();
          })
          .catch((error) => {
            console.error("åˆ·æ–°æœ€è¿‘æ’­æ”¾æ•°æ®å¤±è´¥:", error);
          });
      }

      // åˆå§‹åŒ–æ’è¡Œæ¦œ
      function initRanking(rankingType = "all") {
        const rankingList = document.getElementById("rankingList");
        rankingList.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

        // æ ¹æ®æ’åç±»å‹è°ƒæ•´APIè¯·æ±‚
        let apiUrl = API_BASE_URL + "/api/track-play-counts?limit=10&offset=0";
        if (rankingType === "month") {
          // æœˆæ’è¡Œæ¦œ
          apiUrl =
            API_BASE_URL + "/api/track-play-counts/period?limit=10&offset=0&period=month";
        } else if (rankingType === "week") {
          // å‘¨æ’è¡Œæ¦œ
          apiUrl =
            API_BASE_URL + "/api/track-play-counts/period?limit=10&offset=0&period=week";
        }

        fetch(apiUrl)
          .then((response) => {
            if (!response.ok) {
              throw new Error("ç½‘ç»œå“åº”é”™è¯¯");
            }
            return response.json();
          })
          .then((data) => {
            // ç§»é™¤åŠ è½½çŠ¶æ€
            const loadingElement = rankingList.querySelector(".loading");
            if (loadingElement) {
              loadingElement.remove();
            }

            if (data.length === 0) {
              rankingList.innerHTML = '<div class="loading">æš‚æ— æ•°æ®</div>';
              return;
            }

            data.forEach((item, index) => {
              const rankingItem = document.createElement("li");
              rankingItem.className = "ranking-item";

              const rank = index + 1;
              let rankClass = "rank-other";
              if (rank === 1) rankClass = "rank-1";
              else if (rank === 2) rankClass = "rank-2";
              else if (rank === 3) rankClass = "rank-3";

              rankingItem.innerHTML = `
                                  <div class="rank-number ${rankClass}">${rank}</div>
                                  <div class="track-info">
                                      <div class="track-title">${item.track}</div>
                                      <div class="track-artist">${item.artist} - ${item.album}</div>
                                  </div>
                                  <div class="play-count">${item.play_count} æ¬¡</div>
                              `;

              // æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†
              rankingItem.addEventListener('click', function() {
                showTrackDetails(item.artist, item.album, item.track);
              });
              rankingItem.style.cursor = 'pointer';

              rankingList.appendChild(rankingItem);
            });

            // è°ƒæ•´ä¸¤ä¸ªåˆ—è¡¨çš„é«˜åº¦
            adjustRankingListsHeight();
          })
          .catch((error) => {
            console.error("è·å–æ’è¡Œæ¦œæ•°æ®å¤±è´¥:", error);
            // ç§»é™¤åŠ è½½çŠ¶æ€
            const loadingElement = rankingList.querySelector(".loading");
            if (loadingElement) {
              loadingElement.remove();
            }
            rankingList.innerHTML =
              '<div class="error">åŠ è½½å¤±è´¥: ' + error.message + "</div>";
          });
      }

      // è°ƒæ•´æ’è¡Œæ¦œåˆ—è¡¨é«˜åº¦ï¼Œä½¿ä¸¤ä¸ªå¡ç‰‡ä¿æŒä¸€è‡´
      function adjustRankingListsHeight() {
        const recentPlaysList = document.getElementById("recentPlaysList");
        const rankingList = document.getElementById("rankingList");

        // é‡ç½®é«˜åº¦
        recentPlaysList.style.height = "auto";
        rankingList.style.height = "auto";

        // è·å–ä¸¤ä¸ªåˆ—è¡¨çš„æœ€å¤§é«˜åº¦
        const recentPlaysHeight = recentPlaysList.offsetHeight;
        const rankingHeight = rankingList.offsetHeight;
        const maxHeight = Math.max(recentPlaysHeight, rankingHeight);

        // è®¾ç½®ä¸¤ä¸ªåˆ—è¡¨çš„é«˜åº¦ä¸ºæœ€å¤§é«˜åº¦
        if (maxHeight > 0) {
          // åªåœ¨éœ€è¦æ—¶è®¾ç½®å›ºå®šé«˜åº¦ï¼Œé¿å…å½±å“å¸ƒå±€
          if (recentPlaysHeight !== rankingHeight) {
            recentPlaysList.style.height = maxHeight + "px";
            rankingList.style.height = maxHeight + "px";
          }
        }
      }

      // åŠ è½½æœªä¸ŠæŠ¥è®°å½•
      function loadUnscrobbledRecords() {
        const content = document.getElementById("unscrobbledContent");
        content.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

        const offset = (currentUnscrobbledPage - 1) * unscrobbledPageSize;

        // è·å–æœªä¸ŠæŠ¥è®°å½•æ€»æ•°
        fetch(API_BASE_URL + "/api/unscrobbled-records/count")
          .then((response) => {
            if (!response.ok) {
              throw new Error("ç½‘ç»œå“åº”é”™è¯¯");
            }
            return response.json();
          })
          .then((data) => {
            totalUnscrobbledRecords = data.count;
            updatePagination();
          })
          .catch((error) => {
            console.error("è·å–æœªä¸ŠæŠ¥è®°å½•æ€»æ•°å¤±è´¥:", error);
          });

        // è·å–æœªä¸ŠæŠ¥è®°å½•
        fetch(
          `${API_BASE_URL}/api/unscrobbled-records?limit=${unscrobbledPageSize}&offset=${offset}`
        )
          .then((response) => {
            if (!response.ok) {
              throw new Error("ç½‘ç»œå“åº”é”™è¯¯");
            }
            return response.json();
          })
          .then((data) => {
            renderUnscrobbledRecords(data);
          })
          .catch((error) => {
            console.error("è·å–æœªä¸ŠæŠ¥è®°å½•å¤±è´¥:", error);
            content.innerHTML =
              '<div class="error">åŠ è½½å¤±è´¥: ' + error.message + "</div>";
          });
      }

      // æ¸²æŸ“æœªä¸ŠæŠ¥è®°å½•
      function renderUnscrobbledRecords(records) {
        const content = document.getElementById("unscrobbledContent");

        if (records.length === 0) {
          content.innerHTML = '<div class="loading">æš‚æ— æœªä¸ŠæŠ¥è®°å½•</div>';
          return;
        }

        // æ£€æŸ¥æ˜¯å¦å¤„äºæš—è‰²æ¨¡å¼
        const isDark = document.body.classList.contains("dark-mode");

        // æ ¹æ®ä¸»é¢˜è®¾ç½®é¢œè‰²
        const headerBgColor = isDark ? "#3a3a3a" : "#f1f3f9";
        const borderColor = isDark ? "#444444" : "#e9ecef";
        const rowBorderColor = isDark ? "#444444" : "#e9ecef";
        const textColor = isDark ? "#f0f0f0" : "#2c3e50";

        let html = `<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; color: ${textColor};">`;
        html += `<thead><tr style="background-color: ${headerBgColor}; text-align: left;">`;
        html += `<th style="padding: 12px; border-bottom: 2px solid ${borderColor};"></th>`;
        html += `<th style="padding: 12px; border-bottom: 2px solid ${borderColor};">æ›²ç›®</th>`;
        html += `<th style="padding: 12px; border-bottom: 2px solid ${borderColor};">è‰ºæœ¯å®¶</th>`;
        html += `<th style="padding: 12px; border-bottom: 2px solid ${borderColor};">ä¸“è¾‘</th>`;
        html += `<th style="padding: 12px; border-bottom: 2px solid ${borderColor};">æ’­æ”¾æ—¶é—´</th>`;
        html += `<th style="padding: 12px; border-bottom: 2px solid ${borderColor};">æ¥æº</th>`;
        html += "</tr></thead><tbody>";

        records.forEach((record) => {
          const playTime = new Date(record.play_time);
          const timeString = playTime.toLocaleString("zh-CN");

          // æ ¹æ®æ¥æºè®¾ç½®æ ·å¼
          let sourceClass = "";
          let sourceText = "";
          switch (record.source?.toLowerCase()) {
            case "apple music":
              sourceClass = "source-applemusic";
              sourceText = "AppleMusic";
              break;
            case "audirvana":
            case "au":
              sourceClass = "source-audirvana";
              sourceText = "Audirvana";
              break;
            case "roon":
              sourceClass = "source-roon";
              sourceText = "Roon";
              break;
            default:
              sourceClass = "";
              sourceText = record.source || "Unknown";
          }

          html += `<tr style="border-bottom: 1px solid ${rowBorderColor};">`;
          html += `<td style="padding: 12px;"><input type="checkbox" class="record-checkbox" data-id="${record.id}"></td>`;
          html += `<td style="padding: 12px;">${record.track}</td>`;
          html += `<td style="padding: 12px;">${record.artist}</td>`;
          html += `<td style="padding: 12px;">${record.album}</td>`;
          html += `<td style="padding: 12px;">${timeString}</td>`;
          html += `<td style="padding: 12px;"><div class="play-source ${sourceClass}" style="display: inline-block;">${sourceText}</div></td>`;
          html += "</tr>";
        });

        html += "</tbody></table></div>";
        content.innerHTML = html;
      }

      // æ›´æ–°åˆ†é¡µä¿¡æ¯
      function updatePagination() {
        const totalPages = Math.ceil(
          totalUnscrobbledRecords / unscrobbledPageSize
        );
        const pageInfo = document.getElementById("pageInfo");
        const prevBtn = document.getElementById("prevPage");
        const nextBtn = document.getElementById("nextPage");

        // æ£€æŸ¥æ˜¯å¦å¤„äºæš—è‰²æ¨¡å¼
        const isDark = document.body.classList.contains("dark-mode");

        // è®¾ç½®åˆ†é¡µä¿¡æ¯æ–‡æœ¬é¢œè‰²
        if (pageInfo) {
          pageInfo.style.color = isDark ? "var(--text-primary)" : "#2c3e50";
        }

        if (totalUnscrobbledRecords === 0) {
          pageInfo.textContent = "æ— è®°å½•";
          prevBtn.disabled = true;
          nextBtn.disabled = true;
          return;
        }

        pageInfo.textContent = `ç¬¬ ${currentUnscrobbledPage} é¡µï¼Œå…± ${totalPages} é¡µ (${totalUnscrobbledRecords} æ¡è®°å½•)`;
        prevBtn.disabled = currentUnscrobbledPage === 1;
        nextBtn.disabled = currentUnscrobbledPage === totalPages;
      }

      // åŒæ­¥é€‰ä¸­çš„è®°å½•
      function syncSelectedRecords() {
        const checkboxes = document.querySelectorAll(
          ".record-checkbox:checked"
        );
        if (checkboxes.length === 0) {
          alert("è¯·å…ˆé€‰æ‹©è¦åŒæ­¥çš„è®°å½•");
          return;
        }

        const ids = Array.from(checkboxes).map((cb) => parseInt(cb.dataset.id));

        // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const syncBtn = document.getElementById("syncSelectedBtn");
        const originalText = syncBtn.textContent;
        syncBtn.textContent = "åŒæ­¥ä¸­...";
        syncBtn.disabled = true;

        fetch(API_BASE_URL + "/api/unscrobbled-records/sync", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ ids: ids }),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("ç½‘ç»œå“åº”é”™è¯¯");
            }
            return response.json();
          })
          .then((data) => {
            if (data.failed_count > 0) {
              alert(
                `åŒæ­¥å®Œæˆ: ${data.success_count} æ¡è®°å½•åŒæ­¥æˆåŠŸ, ${data.failed_count} æ¡è®°å½•åŒæ­¥å¤±è´¥`
              );
              // æ˜¾ç¤ºå¤±è´¥çš„è®°å½•
              if (data.failed_records && data.failed_records.length > 0) {
                let failedList = "åŒæ­¥å¤±è´¥çš„è®°å½•:\n";
                data.failed_records.forEach((record) => {
                  failedList += `- ${record.track} - ${record.artist}\n`;
                });
                console.log(failedList);
              }
            } else {
              alert(`åŒæ­¥å®Œæˆ: ${data.success_count} æ¡è®°å½•åŒæ­¥æˆåŠŸ`);
            }

            // é‡æ–°åŠ è½½æœªä¸ŠæŠ¥è®°å½•
            loadUnscrobbledRecords();
          })
          .catch((error) => {
            console.error("åŒæ­¥è®°å½•å¤±è´¥:", error);
            alert("åŒæ­¥è®°å½•å¤±è´¥: " + error.message);
          })
          .finally(() => {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            syncBtn.textContent = originalText;
            syncBtn.disabled = false;
          });
      }

      // å®šæ—¶æ›´æ–°å‡½æ•°
      function createAutoUpdater(fetchFunction, interval = 60000) {
        return setInterval(fetchFunction, interval);
      }

      // å…¬å…±çš„å®šæ—¶æ›´æ–°å‡½æ•°
      function createDashboardAutoUpdater() {
        // å­˜å‚¨æ‰€æœ‰å®šæ—¶å™¨çš„ID
        const timers = [];

        // æ¸…é™¤æ‰€æœ‰å®šæ—¶å™¨
        function clearAllTimers() {
          timers.forEach((timerId) => clearInterval(timerId));
          timers.length = 0; // æ¸…ç©ºæ•°ç»„
        }

        // æ·»åŠ å®šæ—¶å™¨åˆ°æ•°ç»„
        function addTimer(timerId) {
          timers.push(timerId);
        }

        // è¿”å›å…¬å…±æ¥å£
        return {
          clearAllTimers,
          addTimer,
        };
      }

      // åˆ›å»ºå…¨å±€çš„å®šæ—¶æ›´æ–°å™¨å®ä¾‹
      const dashboardUpdater = createDashboardAutoUpdater();

      // åˆå§‹åŒ–æ‹–åŠ¨åŠŸèƒ½
      function initDraggableCards() {
        // æœ€è¿‘æ’­æ”¾å’Œæ’­æ”¾æ’è¡Œæ¦œä¸å†æ”¯æŒæ‹–åŠ¨
      }

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", function () {
        // è‡ªåŠ¨åˆ‡æ¢æ—¥å¤œæ¨¡å¼
        toggleDarkModeBasedOnSystem();

        // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
        watchSystemThemeChange();

        // åˆå§‹åŒ–å„ä¸ªç»„ä»¶
        initStats();
        initSourceChart(); // åˆå§‹åŒ–æ’­æ”¾æ¥æºæ‰‡å½¢å›¾
        initTrendChart(30); // é»˜è®¤åŠ è½½30å¤©æ•°æ®
        initArtistChart("plays"); // é»˜è®¤æŒ‰æ’­æ”¾æ¬¡æ•°æ’åº
        initAlbumChart(30); // é»˜è®¤åŠ è½½30å¤©æ•°æ®
        initGenreChart(); // åˆå§‹åŒ–çƒ­é—¨æµæ´¾å›¾è¡¨
        initRanking("all"); // é»˜è®¤æ€»æ’è¡Œ
        initRecentPlays(); // åˆå§‹åŒ–æœ€è¿‘æ’­æ”¾åˆ—è¡¨

        // è¿æ¥åˆ°WebSocketæœåŠ¡å™¨
        // connectWebSocket(); // é™æ€ç‰ˆæœ¬ä¸æ”¯æŒ WebSocket

        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        dashboardUpdater.clearAllTimers();

        // è®¾ç½®å®šæ—¶å™¨ï¼Œä½†æ ¹æ®ç”¨æˆ·éœ€æ±‚ï¼Œæš‚æ—¶ç¦ç”¨è‡ªåŠ¨åˆ·æ–°ï¼Œæ”¹ä¸ºæ‰‹åŠ¨åˆ·æ–°é¡µé¢
        // dashboardUpdater.addTimer(createAutoUpdater(initStats, 60000)); 
		// ... auto update logic removed


        // æ·»åŠ æ—¶é—´è¿‡æ»¤å™¨ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll(".time-filter").forEach((filter) => {
          // è·³è¿‡å…¨å±æŒ‰é’®
          if (
            filter.id === "trendChartFullscreenBtn" ||
            filter.id === "genreChartFullscreenBtn"
          )
            return;

          filter.addEventListener("click", function () {
            // ç§»é™¤åŒç»„å…¶ä»–è¿‡æ»¤å™¨çš„activeç±»
            const parent = this.parentElement;
            parent.querySelectorAll(".time-filter").forEach((f) => {
              // è·³è¿‡å…¨å±æŒ‰é’®
              if (
                f.id === "trendChartFullscreenBtn" ||
                f.id === "genreChartFullscreenBtn"
              )
                return;
              f.classList.remove("active");
            });

            // ä¸ºå½“å‰è¿‡æ»¤å™¨æ·»åŠ activeç±»
            this.classList.add("active");

            // æ ¹æ®è¿‡æ»¤å™¨æ›´æ–°æ•°æ®
            const filterType = parent.classList.contains("card-header")
              ? parent.parentElement.querySelector(".card-title").textContent
              : parent.closest(".chart-card")
              ? parent.closest(".chart-card").querySelector(".card-title")
                  .textContent
              : parent.closest(".ranking-card").querySelector(".card-title")
                  .textContent;

            if (filterType.includes("æ’­æ”¾è¶‹åŠ¿")) {
              // æ›´æ–°è¶‹åŠ¿å›¾
              const range = this.getAttribute("data-range");
              initTrendChart(range);
            } else if (filterType.includes("çƒ­é—¨è‰ºæœ¯å®¶")) {
              // æ›´æ–°è‰ºæœ¯å®¶å›¾è¡¨
              const type = this.getAttribute("data-type");
              initArtistChart(type);
            } else if (filterType.includes("çƒ­é—¨ä¸“è¾‘")) {
              // æ›´æ–°ä¸“è¾‘å›¾è¡¨
              const days = this.getAttribute("data-days");
              initAlbumChart(days);
            } else if (filterType.includes("æ’­æ”¾æ’è¡Œæ¦œ")) {
              // æ›´æ–°æ’è¡Œæ¦œ
              const ranking = this.getAttribute("data-ranking");
              initRanking(ranking);
            }
          });
        });

        // å…¨å±æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document
          .getElementById("trendChartFullscreenBtn")
          .addEventListener("click", function () {
            toggleTrendChartFullscreen();
          });

        // å£å‘³æµæ´¾å›¾è¡¨å…¨å±æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document
          .getElementById("genreChartFullscreenBtn")
          .addEventListener("click", function () {
            toggleGenreChartFullscreen();
          });

        // é¡µé¢åŠ è½½å®Œæˆåè°ƒæ•´æ’è¡Œæ¦œåˆ—è¡¨é«˜åº¦
        setTimeout(adjustRankingListsHeight, 1000);

        // åˆå§‹åŒ–æ‹–åŠ¨åŠŸèƒ½
        initDraggableCards();

        // åˆå§‹åŒ–æ­£åœ¨æ’­æ”¾æ‚¬æµ®çª—çš„æ‹–åŠ¨åŠŸèƒ½
        initNowPlayingDrag();

        // æœªä¸ŠæŠ¥æ ‡ç­¾é¡µç‚¹å‡»äº‹ä»¶
        document
          .getElementById("unscrobbledTab")
          .addEventListener("click", function (e) {
            e.preventDefault();

            // éšè—å…¶ä»–å†…å®¹
            document.querySelector(".stats-container").style.display = "none";
            document.querySelector(".charts-container").style.display = "none";
            document.querySelector(".rankings-container").style.display =
              "none";

            // æ˜¾ç¤ºæœªä¸ŠæŠ¥å®¹å™¨
            document.getElementById("unscrobbledContainer").style.display =
              "block";

            // æ›´æ–°å¯¼èˆªæ æ´»åŠ¨çŠ¶æ€
            document.querySelectorAll(".nav-links a").forEach((link) => {
              link.classList.remove("active");
            });
            this.classList.add("active");

            // åŠ è½½æœªä¸ŠæŠ¥è®°å½•
            currentUnscrobbledPage = 1;
            loadUnscrobbledRecords();
          });

        // åˆ·æ–°æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document
          .getElementById("refreshUnscrobbledBtn")
          .addEventListener("click", function () {
            loadUnscrobbledRecords();
          });

        // åŒæ­¥é€‰ä¸­æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document
          .getElementById("syncSelectedBtn")
          .addEventListener("click", function () {
            syncSelectedRecords();
          });

        // åˆ†é¡µæŒ‰é’®äº‹ä»¶
        document
          .getElementById("prevPage")
          .addEventListener("click", function () {
            if (currentUnscrobbledPage > 1) {
              currentUnscrobbledPage--;
              loadUnscrobbledRecords();
            }
          });

        document
          .getElementById("nextPage")
          .addEventListener("click", function () {
            const totalPages = Math.ceil(
              totalUnscrobbledRecords / unscrobbledPageSize
            );
            if (currentUnscrobbledPage < totalPages) {
              currentUnscrobbledPage++;
              loadUnscrobbledRecords();
            }
          });

        // ç‚¹èµæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document
          .getElementById("favoriteButton")
          .addEventListener("click", handleFavoriteButtonClick);
      });

      // æ·»åŠ æŸ¥çœ‹è¯¦æƒ…æ¨¡æ€æ¡†ç›¸å…³å‡½æ•°
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      function showModal(modalId) {
        document.getElementById(modalId).style.display = "block";
      }

      // éšè—æ¨¡æ€æ¡†
      function hideModal(modalId) {
        document.getElementById(modalId).style.display = "none";
      }

      // è·å–å¹¶æ˜¾ç¤ºæ›²ç›®è¯¦ç»†ä¿¡æ¯
      function showTrackDetails(artist, album, trackName) {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const modalContent = document.querySelector("#trackDetailsModal .modal-content");
        modalContent.innerHTML = `<div class="loading">åŠ è½½ä¸­...</div>`;
        showModal("trackDetailsModal");

        // ä»åç«¯è·å–è¯¦ç»†ä¿¡æ¯
        fetch(`${API_BASE_URL}/api/track?artist=${encodeURIComponent(artist)}&album=${encodeURIComponent(album)}&trackName=${encodeURIComponent(trackName)}`)
          .then(response => {
            if (!response.ok) {
              throw new Error("ç½‘ç»œå“åº”é”™è¯¯");
            }
            return response.json();
          })
          .then(data => {
            // æ¸²æŸ“è¯¦ç»†ä¿¡æ¯
            renderTrackDetails(data);
          })
          .catch(error => {
            console.error("è·å–æ›²ç›®è¯¦æƒ…å¤±è´¥:", error);
            modalContent.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
          });
      }

      // æ¸²æŸ“æ›²ç›®è¯¦ç»†ä¿¡æ¯
      function renderTrackDetails(track) {
        const modalContent = document.querySelector("#trackDetailsModal .modal-content");
        
        // æ ¼å¼åŒ–æ’­æ”¾æ—¶é—´
        const formatDuration = (seconds) => {
          const mins = Math.floor(seconds / 60);
          const secs = Math.floor(seconds % 60);
          return `${mins}:${secs.toString().padStart(2, "0")}`;
        };

        // æ ¹æ®æ¥æºè®¾ç½®æ ·å¼
        let sourceClass = "";
        let sourceText = "";
        switch (track.source?.toLowerCase()) {
          case "apple music":
            sourceClass = "source-applemusic";
            sourceText = "AppleMusic";
            break;
          case "audirvana":
          case "au":
            sourceClass = "source-audirvana";
            sourceText = "Audirvana";
            break;
          case "roon":
            sourceClass = "source-roon";
            sourceText = "Roon";
            break;
          default:
            sourceClass = "";
            sourceText = track.source || "Unknown";
        }

        // æ ¹æ®å–œæ¬¢çŠ¶æ€è®¾ç½®æ˜¾ç¤ºæ–‡æœ¬
        const appleMusicFavText = track.is_apple_music_fav ? "æ˜¯" : "å¦";
        const lastFmFavText = track.is_last_fm_fav ? "æ˜¯" : "å¦";

        modalContent.innerHTML = `
          <div class="modal-header">
            <h2>${track.track}</h2>
            <span class="close" onclick="hideModal('trackDetailsModal')">Ã—</span>
          </div>
          <div class="modal-body">
            <div class="track-info">
              <p><strong>è‰ºæœ¯å®¶:</strong> ${track.artist}</p>
              <p><strong>ä¸“è¾‘:</strong> ${track.album}</p>
              <p><strong>æ’­æ”¾æ¬¡æ•°:</strong> ${track.play_count}</p>
              ${track.duration ? `<p><strong>æ—¶é•¿:</strong> ${formatDuration(track.duration)}</p>` : ''}
              ${track.track_number ? `<p><strong>æ›²ç›®ç¼–å·:</strong> ${track.track_number}</p>` : ''}
              ${track.genre ? `<p><strong>æµæ´¾:</strong> ${track.genre}</p>` : ''}
              ${track.composer ? `<p><strong>ä½œæ›²å®¶:</strong> ${track.composer}</p>` : ''}
              ${track.release_date ? `<p><strong>å‘è¡Œæ—¥æœŸ:</strong> ${track.release_date}</p>` : ''}
              ${track.music_brainz_id ? `<p><strong>MusicBrainz ID:</strong> ${track.music_brainz_id}</p>` : ''}
              <p><strong>å–œæ¬¢è‹¹æœéŸ³ä¹:</strong> ${appleMusicFavText}</p>
              <p><strong>å–œæ¬¢Last.fm:</strong> ${lastFmFavText}</p>
              <p><strong>æ•°æ®æ¥æº:</strong> <span class="play-source ${sourceClass}">${sourceText}</span></p>
              ${track.bundle_id ? `<p><strong>åº”ç”¨æ ‡è¯†ç¬¦:</strong> ${track.bundle_id}</p>` : ''}
              ${track.unique_id ? `<p><strong>å”¯ä¸€æ ‡è¯†ç¬¦:</strong> ${track.unique_id}</p>` : ''}
              <p><strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(track.created_at).toLocaleString('zh-CN')}</p>
              <p><strong>æ›´æ–°æ—¶é—´:</strong> ${new Date(track.updated_at).toLocaleString('zh-CN')}</p>
            </div>
          </div>
        `;
      }
    </script>
    
    <!-- æ›²ç›®è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="trackDetailsModal" class="modal">
      <div class="modal-content">
        <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
      </div>
    </div>
  </body>
</html>
